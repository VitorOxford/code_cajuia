<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Cajuia</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            /* Light Mode */
            --bg-color-light: #F0F2F5;
            --sidebar-bg-light: rgba(255, 255, 255, 0.9);
            --card-bg-light: #FFFFFF;
            --primary-color-light: #007AFF;
            --primary-color-light-hover: #0056b3;
            --primary-color-light-active: #003d80;
            --primary-color-light-fade: #e6f2ff;
            --text-primary-light: #1A202C;
            --text-secondary-light: #6B7280;
            --border-color-light: #E2E8F0;
            --danger-color-light: #EF4444;
            --success-color-light: #10B981;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);

            /* Dark Mode */
            --bg-color-dark: #1A202C;
            --sidebar-bg-dark: rgba(26, 32, 44, 0.9);
            --card-bg-dark: #2D3748;
            --primary-color-dark: #66B2FF;
            --primary-color-dark-hover: #4DA0EA;
            --primary-color-dark-active: #368AD3;
            --primary-color-dark-fade: #1F2937;
            --text-primary-dark: #E2E8F0;
            --text-secondary-dark: #A0AEC0;
            --border-color-dark: #4A5568;
            --danger-color-dark: #F87171;
            --success-color-dark: #4ade80;
            --shadow-dark: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);

            /* Common */
            --font-family-sans: 'Inter', 'Poppins', sans-serif;
            --font-family-serif: 'Playfair Display', serif;
            --radius-xl: 1.5rem;
            --radius-lg: 1rem;
            --radius-md: 0.75rem;
            --radius-sm: 0.5rem;
        }

        [data-theme='light'] {
            --bg-color: var(--bg-color-light);
            --sidebar-bg: var(--sidebar-bg-light);
            --card-bg: var(--card-bg-light);
            --primary-color: var(--primary-color-light);
            --primary-color-hover: var(--primary-color-light-hover);
            --primary-color-active: var(--primary-color-light-active);
            --primary-color-fade: var(--primary-color-light-fade);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-color-light);
            --danger-color: var(--danger-color-light);
            --success-color: var(--success-color-light);
            --shadow: var(--shadow-light);
        }

        [data-theme='dark'] {
            --bg-color: var(--bg-color-dark);
            --sidebar-bg: var(--sidebar-bg-dark);
            --card-bg: var(--card-bg-dark);
            --primary-color: var(--primary-color-dark);
            --primary-color-hover: var(--primary-color-dark-hover);
            --primary-color-active: var(--primary-color-dark-active);
            --primary-color-fade: var(--primary-color-dark-fade);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-color-dark);
            --danger-color: var(--danger-color-dark);
            --success-color: var(--success-color-dark);
            --shadow: var(--shadow-dark);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: var(--font-family-sans);
            background-color: var(--bg-color);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Global Reusable Styles --- */
        .card { 
            background-color: var(--card-bg); 
            border-radius: var(--radius-xl); 
            padding: 2rem; 
            box-shadow: var(--shadow); 
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: var(--radius-md); 
            border: none; 
            font-weight: 600; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-color-hover); }
        .btn-primary:disabled { 
            background-color: var(--border-color); 
            color: var(--text-secondary); 
            cursor: not-allowed; 
            opacity: 0.7;
        }
        .btn-danger { 
            background-color: var(--danger-color); 
            color: white; 
        }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-secondary { 
            background-color: var(--border-color); 
            color: var(--text-primary); 
        }
        .btn-secondary:hover { background-color: var(--text-secondary); color: var(--card-bg); }
        .btn-icon { 
            background: none; 
            border: none; 
            padding: 0.5rem; 
            border-radius: 50%; 
            width: 36px; 
            height: 36px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-icon:hover { background-color: var(--border-color); }
        .btn-icon svg { width: 20px; height: 20px; color: var(--text-secondary); transition: color 0.2s;}
        .btn-icon:hover svg { color: var(--text-primary); }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 0.75rem 1rem; 
            border-radius: var(--radius-md); 
            border: 1px solid var(--border-color); 
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-size: 1rem; 
            font-family: var(--font-family-sans); 
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; 
        }
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px var(--primary-color-fade); 
            outline: none; 
        }

        /* --- Loading Screen --- */
        #loading-screen { 
            position: fixed; 
            inset: 0; 
            background-color: var(--bg-color); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.5s ease-out, background-color 0.3s ease; 
        }
        .loading-logo { width: 200px; margin-bottom: 2rem; animation: pulse 2s infinite alternate; }
        @keyframes pulse {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.05); opacity: 1; }
        }
        .loading-progress-bar { 
            width: 280px; 
            height: 8px; 
            background-color: var(--border-color); 
            border-radius: 4px; 
            overflow: hidden; 
            margin-bottom: 1.5rem; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        #loading-bar { 
            width: 0%; 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary-color), var(--primary-color-hover)); 
            border-radius: 4px; 
            transition: width 1.4s cubic-bezier(0.25, 1, 0.5, 1); 
        }
        .loading-texts { height: 20px; text-align: center; width: 280px; position: relative; }
        .loading-texts p { 
            position: absolute; 
            inset: 0; 
            font-weight: 500; 
            color: var(--text-secondary); 
            opacity: 0; 
            transition: opacity 0.4s ease-in-out; 
            font-size: 0.95rem;
        }
        .loading-texts p.visible { opacity: 1; }
        
        /* --- Login Modal/Screen --- */
        #login-modal {
            position: fixed;
            inset: 0;
            background-color: var(--bg-color);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            transition: background-color 0.3s ease;
        }
        #login-modal .login-card {
            background-color: var(--card-bg);
            padding: 3rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            gap: 1.5rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #login-modal h2 {
            font-family: var(--font-family-serif);
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }
        #login-modal input[type="email"],
        #login-modal input[type="password"] {
            width: 100%;
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            font-size: 1rem;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        #login-modal input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-color-fade);
            outline: none;
        }
        #login-modal #login-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: var(--radius-md);
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        #login-modal #login-btn:hover {
            background-color: var(--primary-color-hover);
        }
        #login-modal #login-btn:active {
            transform: scale(0.98);
        }
        #login-modal #login-erro {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 1rem;
            text-align: center;
            min-height: 20px; /* Reserve space */
        }
        #login-modal .logo-large {
            width: 180px; /* Adjust size as needed */
            margin-bottom: 2rem;
        }

        /* --- Main Layout --- */
        #app-wrapper { 
            display: flex; 
            opacity: 0; /* Starts hidden, shown after loading */
            transition: opacity 0.5s ease-in; 
        }
        #sidebar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 280px; /* Slightly wider sidebar */
            height: 100vh; 
            background: var(--sidebar-bg); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-right: 1px solid var(--border-color); 
            padding: 2rem 1.5rem; /* More padding */
            display: flex; 
            flex-direction: column; 
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; 
            z-index: 500;
        }
        #main-content { 
            margin-left: 280px; 
            width: calc(100% - 280px); 
            padding: 2.5rem; /* More generous padding */
            transition: margin-left 0.3s ease;
        }
        .sidebar-logo { height: 48px; margin-bottom: 3rem; align-self: center; } /* Larger logo */
        .nav-menu { display: flex; flex-direction: column; gap: 0.75rem; } /* More space between links */
        .nav-link { 
            display: flex; 
            align-items: center; 
            gap: 1.25rem; /* Larger gap for icons and text */
            padding: 0.9rem 1.25rem; /* More padding */
            border-radius: var(--radius-md); 
            text-decoration: none; 
            color: var(--text-secondary); 
            font-weight: 500; 
            transition: background-color 0.2s, color 0.2s; 
            font-size: 1.05rem;
        }
        .nav-link:hover { 
            background-color: var(--primary-color-fade); 
            color: var(--text-primary); 
        }
        .nav-link.active { 
            background-color: var(--primary-color); 
            color: white; 
            box-shadow: var(--shadow);
        }
        .nav-link.active svg { color: white; }
        .nav-link svg { width: 22px; height: 22px; color: var(--text-secondary); transition: color 0.2s; }
        .nav-link:hover svg { color: var(--text-primary); }

        .theme-switch-container {
            margin-top: auto; /* Pushes to the bottom */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .theme-switch-container span {
            font-weight: 600;
            color: var(--text-primary);
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 28px;
        }
        .theme-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .theme-slider {
            background-color: var(--primary-color);
        }
        input:checked + .theme-slider:before {
            transform: translateX(22px);
        }


        main header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2rem; 
            gap: 1rem;
        }
        main header h1 { 
            font-size: 2.5rem; /* Larger headings */
            font-weight: 700; 
            color: var(--text-primary);
            font-family: var(--font-family-sans);
        }
        
        /* --- Table --- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 0.75rem; }
        th, td { text-align: left; padding: 1.1rem 1.5rem; vertical-align: middle; } /* More padding */
        th { 
            font-weight: 600; 
            color: var(--text-secondary); 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            border-bottom: 1px solid var(--border-color); /* Separator */
            padding-bottom: 1rem;
        }
        tbody tr { 
            background-color: var(--card-bg); 
            transition: background-color 0.2s, box-shadow 0.2s; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); 
        }
        tbody tr:hover { 
            background-color: var(--primary-color-fade); 
            box-shadow: var(--shadow); 
            transform: translateY(-2px); /* Subtle lift effect */
        }
        td { color: var(--text-primary); font-weight: 500; }
        td:first-child { border-top-left-radius: var(--radius-lg); border-bottom-left-radius: var(--radius-lg); }
        td:last-child { border-top-right-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg); }
        .actions-cell { display: flex; justify-content: flex-end; gap: 0.5rem; }
        .product-image-sm { 
            width: 50px; 
            height: 50px; 
            border-radius: var(--radius-md); 
            object-fit: cover; 
            margin-right: 1rem;
            border: 1px solid var(--border-color);
        }
        
        /* --- Modal --- */
        .modal-backdrop { 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0,0,0,0.4); /* Darker backdrop */
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            z-index: 800; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1.5rem; 
            opacity: 0; 
            transition: opacity 0.3s; 
            pointer-events: none; 
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { 
            background-color: var(--card-bg); 
            border-radius: var(--radius-xl); 
            padding: 2.5rem; /* More padding */
            box-shadow: var(--shadow-lg); 
            width: 100%; 
            max-width: 680px; /* Wider modal */
            transform: scale(0.95) translateY(20px); /* Slightly more pronounced animation */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            max-height: 90vh; 
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .modal-backdrop.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2rem; 
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2 { 
            font-size: 1.8rem; 
            color: var(--primary-color);
        }
        .modal-header .btn-icon { color: var(--text-secondary); }
        .modal-footer { 
            display: flex; 
            justify-content: flex-end; 
            gap: 1rem; 
            margin-top: 2rem; 
            border-top: 1px solid var(--border-color); 
            padding-top: 1.5rem; 
        }
        
        /* --- Notifications --- */
        #notification-container { 
            position: fixed; 
            top: 2rem; 
            right: 2rem; 
            z-index: 900; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            pointer-events: none; /* Allow clicks through */
        }
        .notification { 
            background: var(--card-bg); /* Use card background for consistency */
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            padding: 1.2rem 1.8rem; /* More padding */
            border-radius: var(--radius-md); 
            box-shadow: var(--shadow-lg); 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; 
            border: 1px solid var(--border-color);
            min-width: 280px;
        }
        .notification.hiding { animation: slideOut 0.4s ease-out forwards; }
        .notification p { font-weight: 600; color: var(--text-primary); }
        .notification.success { border-left: 5px solid var(--success-color); }
        .notification.error { border-left: 5px solid var(--danger-color); }
        .notification svg { width: 24px; height: 24px; }
        .notification.success svg { color: var(--success-color); }
        .notification.error svg { color: var(--danger-color); }

        /* --- Personalization Tab --- */
        .customization-layout { 
            display: grid; 
            grid-template-columns: 1fr 420px; 
            gap: 2rem; 
            align-items: flex-start; 
        }
        .toggle-switch-group {
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 1rem 1.5rem; 
            background-color: var(--primary-color-fade); /* Lighter background for toggles */
            border-radius: var(--radius-lg); 
            margin-bottom: 1.5rem; 
            border: 1px solid var(--border-color);
        }
        .toggle-switch-group label { 
            font-weight: 600; 
            color: var(--text-primary);
        }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 50px; 
            height: 28px; 
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: var(--border-color); 
            transition: .4s; 
            border-radius: 28px; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 20px; 
            width: 20px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        #banner-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .banner-item { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            background-color: var(--bg-color); /* Use background color for items */
            padding: 0.75rem 1rem; 
            border-radius: var(--radius-md); 
            border: 1px solid var(--border-color);
            transition: background-color 0.2s, transform 0.1s;
        }
        .banner-item:hover {
            background-color: var(--primary-color-fade);
            transform: translateY(-1px);
        }
        .banner-item-img { 
            width: 90px; 
            height: 60px; 
            border-radius: var(--radius-sm); 
            object-fit: cover; 
            border: 1px solid var(--border-color);
        }
        .banner-item-title { 
            flex-grow: 1; 
            font-weight: 600; 
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .banner-item-actions { display: flex; gap: 0.25rem; }
        #btn-new-banner { width: 100%; margin-top: 1.5rem; }

        .preview-container { 
            position: sticky; 
            top: 2.5rem; 
            width: 100%; 
            max-width: 400px; 
            height: 720px; 
            border: 10px solid var(--text-primary); /* Phone frame border */
            border-radius: 40px; 
            background: var(--card-bg); 
            overflow: hidden; 
            box-shadow: var(--shadow-lg); 
            font-family: var(--font-family-sans); 
            display: flex;
            flex-direction: column;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        .preview-container::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            z-index: 10;
        }
        .preview-content { 
            width: 100%; 
            height: 100%; 
            overflow-y: auto; 
            scrollbar-width: none; 
        }
        .preview-content::-webkit-scrollbar { display: none; }
        
        /* Preview Carousel Styles */
        .preview-container .hero-carousel-container { 
            position: relative; 
            width: 100%; 
            height: 280px; /* Fixed height for carousel */
            overflow: hidden; 
            background-color: var(--bg-color); /* Fallback background */
        }
        .preview-container .hero-carousel-wrapper { 
            display: flex; 
            height: 100%; 
            transition: transform 0.5s ease-in-out; 
        }
        .preview-container .hero-banner-slide { 
            flex: 0 0 100%; 
            position: relative; 
            background-size: cover; 
            background-position: center; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end; 
            padding: 2.5rem 1.5rem; 
            text-align: center;
        }
        .preview-container .hero-banner-slide::before { 
            content: ''; 
            position: absolute; 
            inset: 0; 
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent 60%); 
            z-index: 1; 
        }
        .preview-container .hero-banner-slide > div { position: relative; z-index: 2; }
        .preview-container .hero-banner-slide h1 { 
            font-family: var(--font-family-serif); 
            font-size: 2rem; 
            line-height: 1.2; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6); 
            margin-bottom: 0.5rem;
        }
        .preview-container .hero-banner-slide span { 
            font-size: 2.8rem; 
            font-family: var(--font-family-serif); 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6); 
            display: block;
            margin-bottom: 0.5rem;
        }
        .preview-container .hero-banner-slide p { 
            font-size: 0.9rem; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4); 
            max-width: 90%;
            margin: 0 auto;
        }
        .preview-container .carousel-dots { 
            position: absolute; 
            bottom: 1rem; 
            left: 50%; 
            transform: translateX(-50%); 
            display: flex; 
            gap: 0.6rem; 
            z-index: 3; 
        }
        .preview-container .dot { 
            width: 10px; /* Slightly larger dots */
            height: 10px; 
            border-radius: 50%; 
            background-color: rgba(255,255,255,0.4); /* Fainter inactive dots */
            transition: all 0.3s; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        .preview-container .dot.active { 
            background-color: white; 
            transform: scale(1.2); 
            border-color: white;
        }

        /* User Table specific styles */
        .user-link { 
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none; /* Remove default underline */
            font-weight: 500;
            transition: color 0.2s;
        }
        .user-link:hover { 
            color: var(--primary-color-hover); 
            text-decoration: underline; 
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1200px) {
            #sidebar { width: 240px; }
            #main-content { margin-left: 240px; }
            main header h1 { font-size: 2.2rem; }
        }

        @media (max-width: 1024px) {
            .customization-layout { 
                grid-template-columns: 1fr; 
                gap: 2.5rem;
            }
            .preview-container { 
                position: relative; 
                top: 0; 
                height: 600px; 
                max-width: 450px; /* Allow wider preview on smaller desktops */
                margin: 0 auto;
            }
            #main-content { padding: 1.5rem; }
        }

        @media (max-width: 768px) {
            #sidebar { 
                transform: translateX(-100%); 
                width: 220px; 
                z-index: 600; 
                box-shadow: var(--shadow-lg);
            }
            #app-wrapper.sidebar-open #sidebar {
                transform: translateX(0%);
            }
            #main-content { 
                margin-left: 0; 
                width: 100%; 
                padding: 1.2rem;
            }
            main header { flex-direction: column; align-items: flex-start; gap: 1.5rem; }
            main header h1 { font-size: 2rem; }
            .modal-content { padding: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; }

            /* Add a menu button for mobile */
            .mobile-menu-button {
                display: block;
                position: fixed;
                top: 1.5rem;
                left: 1.5rem;
                z-index: 700;
                background-color: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                padding: 0.7rem;
                box-shadow: var(--shadow-md);
                cursor: pointer;
            }
            .mobile-menu-button svg {
                width: 24px;
                height: 24px;
                color: var(--text-primary);
            }
        }
        
        @media (max-width: 480px) {
            #login-modal .login-card { padding: 2rem; }
            #login-modal h2 { font-size: 1.8rem; }
            .loading-logo { width: 150px; }
            .loading-progress-bar { width: 200px; }
            .loading-texts { width: 200px; font-size: 0.85rem; }
            main header h1 { font-size: 1.7rem; }
            .card { padding: 1.5rem; }
            .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
            th, td { padding: 0.8rem 1rem; }
            .product-image-sm { width: 40px; height: 40px; }
            .notification { padding: 1rem 1.2rem; }
        }

        .modal-submenu .btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
    </style>
</head>
<body data-theme="light"> <div id="loading-screen">
        <img src="https://cdn.shopify.com/s/files/1/0927/1286/1998/files/Sem_nome__200_x_200_px___1_-removebg-preview.png?v=1750256192" alt="Cajuia Logo" class="loading-logo">
        <div class="loading-progress-bar">
            <div id="loading-bar"></div>
        </div>
        <div class="loading-texts">
            <p id="loading-text-0" class="visible">Iniciando sistema...</p>
            <p id="loading-text-1">Otimizando recursos...</p>
            <p id="loading-text-2">Carregando módulos...</p>
            <p id="loading-text-3">Preparando ambiente...</p>
        </div>
    </div>

    <div id="app-wrapper">
        <div class="mobile-menu-button" id="mobile-menu-button">
            <i data-feather="menu"></i>
        </div>

        <aside id="sidebar">
            <img src="https://cdn.shopify.com/s/files/1/0927/1286/1998/files/Design_sem_nome_-_2025-06-13T102227.591.png?v=1750256134" alt="Cajuia Logo" class="sidebar-logo">
            <nav class="nav-menu">
                <a href="#products" class="nav-link active" data-view="products-view">
                    <i data-feather="package"></i>
                    <span>Produtos</span>
                </a>
                <a href="#categories" class="nav-link" data-view="categories-view">
                    <i data-feather="tag"></i>
                    <span>Categorias</span>
                </a>
                <a href="#personalizacao" class="nav-link" data-view="personalizacao-view">
                    <i data-feather="compass"></i>
                    <span>Personalização</span>
                </a>
                <a href="#users" class="nav-link" data-view="users-view">
                    <i data-feather="users"></i>
                    <span>Usuários</span>
                </a>
            </nav>
            <div class="theme-switch-container">
                <span>Modo Escuro</span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="theme-slider"></span>
                </label>
            </div>
        </aside>

        <main id="main-content">
            <section id="products-view">
                <header>
                    <h1>Produtos</h1>
                    <div style="display: flex; gap: 1rem;">
                        <button id="btn-save-all" class="btn btn-primary" disabled>
                            <i data-feather="save"></i> Salvar Alterações
                        </button>
                        <button id="btn-new-product" class="btn btn-secondary">
                            <i data-feather="plus"></i> Novo Produto
                        </button>
                    </div>
                </header>
                <div class="card">
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Produto</th><th>Categoria</th><th>Preço</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="products-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="categories-view" style="display: none;">
                <header>
                    <h1>Categorias</h1>
                    <div style="display: flex; gap: 1rem;">
                        <button id="btn-save-all-cat" class="btn btn-primary" disabled>
                            <i data-feather="save"></i> Salvar Alterações
                        </button>
                        <button id="btn-new-category" class="btn btn-secondary">
                            <i data-feather="plus"></i> Nova Categoria
                        </button>
                    </div>
                </header>
                <div class="card">
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Ícone</th><th>Nome da Categoria</th><th>Ações</th></tr></thead>
                            <tbody id="categories-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="personalizacao-view" style="display: none;">
                <header>
                    <h1>Personalização da Loja</h1>
                    <button id="btn-save-all-custom" class="btn btn-primary" disabled>
                        <i data-feather="save"></i> Salvar Alterações
                    </button>
                </header>
                <div class="customization-layout">
                    <div class="card">
                        <div class="toggle-switch-group">
                            <label for="hero-active-toggle">Ativar Banner Principal</label>
                            <label class="switch">
                                <input type="checkbox" id="hero-active-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <h2 style="margin-bottom: 1rem; color: var(--text-primary);">Slides do Carrossel</h2>
                        <div id="banner-list"></div>
                        <button id="btn-new-banner" class="btn btn-secondary">
                            <i data-feather="plus"></i> Adicionar Novo Slide
                        </button>
                    </div>
                    <div class="preview-container">
                        <div id="preview-content" class="preview-content">
                            <div class="hero-carousel-container">
                                <div id="preview-carousel-wrapper" class="hero-carousel-wrapper"></div>
                                <div id="preview-carousel-dots" class="carousel-dots"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="users-view" style="display: none;">
                <header>
    <h1>Usuários</h1>
    <div style="display:flex; align-items:center; gap:1rem;">
        <input type="search" id="user-search-input" placeholder="Pesquisar por nome ou email..." class="form-group" style="padding: 0.75rem 1rem; min-width: 250px;">
        <select id="user-sort-select" class="form-group" style="padding: 0.75rem 1rem;">
    <option value="created_at,desc">Mais Recentes</option>
    <option value="nome,asc">Nome (A-Z)</option>
</select>
        <button id="btn-apply-filters" class="btn btn-primary">
             <i data-feather="search"></i> Buscar
        </button>
    </div>
</header>
                <div class="card">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th><th>Email</th><th>Telefone</th><th>Empresa</th><th>CNPJ</th><th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-backdrop" class="modal-backdrop">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <div id="notification-container"></div>

    <div id="login-modal">
        <div class="login-card">
            <img src="https://cdn.shopify.com/s/files/1/0927/1286/1998/files/Sem_nome__200_x_200_px___1_-removebg-preview.png?v=1750256192" alt="Cajuia Logo" class="logo-large">
            <h2>Bem-vindo(a) ao Cajuia Admin</h2>
            <input id="login-email" type="email" placeholder="E-mail" autocomplete="email" required />
            <input id="login-senha" type="password" placeholder="Senha" autocomplete="current-password" required />
            <button id="login-btn">Entrar</button>
            <div id="login-erro"></div>
        </div>
    </div>
    
    <script>
        let jwtToken = null;

        // Initialize Feather Icons
        feather.replace();

        // Theme Toggle Logic
        const themeToggle = document.getElementById('theme-toggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', currentTheme);
        if (currentTheme === 'dark') {
            themeToggle.checked = true;
        }

        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
            feather.replace(); // Re-render icons with new colors
        });


        // Modal Functions
        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-backdrop').classList.add('visible');
            // Re-render Feather icons inside the modal
            feather.replace();
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.remove('visible');
        }

        // Notification Function
        const showNotification = (message, type = 'success') => {
    const container = document.getElementById('notification-container');
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    const icon = type === 'success' ? 'check-circle' : 'alert-triangle';
    notif.innerHTML = `<i data-feather="${icon}"></i><p>${message}</p>`;
    container.appendChild(notif);
    feather.replace();

    // Adiciona a classe para a animação de sumiço após 4 segundos
    setTimeout(() => {
        notif.classList.add('hiding');
    }, 4000);

    // Remove o elemento do DOM após a animação de 0.4s terminar
    // 4000ms (tempo de espera) + 400ms (duração da animação 'slideOut')
    setTimeout(() => {
        // Checa se a notificação ainda existe antes de tentar remover
        if (notif.parentNode) {
            notif.remove();
        }
    }, 4400); 
};

        document.getElementById('login-btn').onclick = async () => {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    document.getElementById('login-erro').innerText = '';
    try {
        // 1. Login pelo Supabase Auth
        const { data: loginData, error: loginError } = await _supabase.auth.signInWithPassword({
            email,
            password: senha
        });
        if (loginError || !loginData.session) {
            document.getElementById('login-erro').innerText = 'Usuário ou senha inválidos!';
            return;
        }

        // 2. Buscar o profile pelo email
        const { data: profile, error: profileError } = await _supabase
            .from('profiles')
            .select('id')
            .eq('email', email)
            .single();

        if (profileError || !profile) {
            document.getElementById('login-erro').innerText = 'Conta não cadastrada!';
            await _supabase.auth.signOut();
            return;
        }

        // 3. Verificar se o id do profile está na tabela admins
        const { data: adminData, error: adminError } = await _supabase
            .from('admins')
            .select('user_id')
            .eq('user_id', profile.id)
            .single();

        if (adminError || !adminData) {
            document.getElementById('login-erro').innerText = 'Você não é admin!';
            await _supabase.auth.signOut();
            return;
        }

        // 4. Libera o painel
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('app-wrapper').style.opacity = '1';
        loadAndRenderUsers();
    } catch (err) {
        document.getElementById('login-erro').innerText = 'Erro inesperado: ' + err.message;
    }
};

        // Supabase client initialization (moved to global scope for broader access if needed)
        const supabaseUrl = 'https://qmiptiariyjekecvyalo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtaXB0aWFyaXlqZWtlY3Z5YWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2NjkwMjMsImV4cCI6MjA2NjI0NTAyM30.Ue2WkDZ9_E89CvDOgUsT_-v6_WepP1bqCL1hLJ648BM';
        const { createClient } = window.supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);


        // Fetch Users (Backend)
        async function fetchUsers() {
    const { data, error } = await _supabase
        .from('profiles')
        .select('*');
    if (error) {
        showNotification('Erro ao buscar usuários: ' + error.message, 'error');
        return [];
    }
    return data;
}

        // Fetch Orders by User (Supabase)
        async function fetchPedidosByUser(userId) {
            const { data, error } = await _supabase
                .from('pedidos')
                .select('id, criado_em, status, valor_total, itens, pagamento_id')
                .eq('user_id', userId)
                .order('criado_em', { ascending: false });

            if (error) {
                showNotification('Erro ao buscar pedidos: ' + error.message, 'error');
                return [];
            }
            return data;
        }

        // Open Pedidos Modal
        async function openPedidosModal(userId, userName) {
            const pedidos = await fetchPedidosByUser(userId);
            let html = `<div class="modal-header"><h2>Pedidos de ${userName}</h2><button type="button" class="btn-icon" id="close-modal-btn"><i data-feather="x"></i></button></div>`;
            if (!pedidos.length) {
                html += `<p style="padding:2rem;text-align:center; color:var(--text-secondary);">Nenhum pedido encontrado para este usuário.</p>`;
            } else {
                html += `<div class="table-wrapper"><table style="width:100%;margin-top:1rem;">
                    <thead>
                        <tr>
                            <th>ID do Pedido</th>
                            <th>Data</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                pedidos.forEach(p => {
                    const statusColor = p.status === 'pago' ? 'var(--success-color)' : 'var(--danger-color)';
                    html += `<tr>
                        <td>${p.id.slice(0, 8)}...</td>
                        <td>${new Date(p.criado_em).toLocaleString()}</td>
                        <td>R$ ${Number(p.valor_total).toFixed(2)}</td>
                        <td><span style="color:${statusColor};font-weight:bold">${p.status === 'pago' ? 'Pago' : 'Não Pago'}</span></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            showModal(html);
            document.getElementById('close-modal-btn').onclick = closeModal;
        }

        // Delete User Profile (Backend, not Supabase profile)
        async function deleteUserProfile(userId) {
            try {
                const response = await fetch(`https://backend-admin-1kal.onrender.com/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: 'Bearer ' + jwtToken
                    }
                });
                if (!response.ok) throw new Error('Erro ao excluir usuário');
                return true;
            } catch (err) {
                showNotification('Erro ao excluir usuário: ' + err.message, 'error');
                return false;
            }
        }

        function renderProfileTab(profile) {
    return `
        <h3>Dados do Perfil</h3>
        <div class="form-grid" style="margin-top:1rem;">
            <p><strong>Email:</strong> ${profile.email || 'N/A'}</p>
            <p><strong>Telefone:</strong> ${profile.telefone || 'N/A'}</p>
            <p><strong>Empresa:</strong> ${profile.empresa || 'N/A'}</p>
            <p><strong>CNPJ:</strong> ${profile.cnpj || 'N/A'}</p>
            <p><strong>Endereço:</strong> ${profile.logradouro || ''}, ${profile.numero || ''} - ${profile.bairro || ''}, ${profile.cidade || ''} - ${profile.uf || ''}</p>
            <p><strong>CEP:</strong> ${profile.cep || 'N/A'}</p>
        </div>
    `;
}

// Função para renderizar a tabela de pedidos
function renderPedidosTab(pedidos) {
    if (pedidos.length === 0) {
        return '<h3 style="margin-top:1.5rem;">Pedidos</h3><p>Nenhum pedido encontrado.</p>';
    }

    let itemsHTML = pedidos.map(p => {
        const statusColor = p.status === 'pago' ? 'var(--success-color)' : (p.status === 'pendente' ? 'var(--danger-color)' : 'var(--text-secondary)');
        // Corrigindo o erro que aconteceria aqui: p.itens pode não ser um array.
        const itensNomes = Array.isArray(p.itens) ? p.itens.map(item => item.nome).join(', ') : 'Itens inválidos';
        
        return `
            <tr>
                <td>${new Date(p.criado_em).toLocaleDateString()}</td>
                <td>R$ ${Number(p.valor_total).toFixed(2)}</td>
                <td><span style="color:${statusColor}; font-weight:bold;">${p.status}</span></td>
                <td>${itensNomes}</td>
            </tr>
        `;
    }).join('');

    return `
        <h3 style="margin-top:1.5rem;">Pedidos</h3>
        <div class="table-wrapper" style="margin-top:1rem;">
            <table>
                <thead><tr><th>Data</th><th>Valor</th><th>Status</th><th>Itens</th></tr></thead>
                <tbody>${itemsHTML}</tbody>
            </table>
        </div>
    `;
}

        function confirmDeleteUser(userId, userName) {
    // Esta função apenas mostra a caixa de diálogo de confirmação do navegador
    if (confirm(`Tem certeza que deseja excluir o usuário "${userName}"? Esta ação é irreversível.`)) {
        // Se o admin clicar "OK", a função de exclusão real é chamada
        deleteUser(userId);
    }
}

async function deleteUser(userId) {
    showModal('<h2>Excluindo usuário...</h2>'); // Feedback para o admin

    try {
        // Deleta o perfil do usuário da sua tabela 'profiles'
        const { error } = await _supabase.from('profiles').delete().eq('id', userId);

        if (error) {
            // Se o Supabase retornar um erro, joga ele para o bloco 'catch'
            throw error;
        }

        showNotification('Usuário excluído com sucesso!', 'success');
        
        // Fecha o modal e recarrega a lista de usuários para refletir a mudança
        closeModal();
        loadAndRenderUsers();

    } catch (error) {
        console.error('ERRO COMPLETO DO SUPABASE:', error); 
        
        showNotification('Erro ao excluir usuário: ' + error.message, 'error');
    }
}


       async function openUserDetailModal(userId) {
    showModal('<h2>Carregando dados do usuário...</h2>');

    try {
        const [profileRes, pedidosRes] = await Promise.all([
            _supabase.from('profiles').select('*').eq('id', userId).single(),
            _supabase.from('pedidos').select('*').eq('user_id', userId).order('criado_em', { ascending: false })
        ]);

        if (profileRes.error) throw profileRes.error;

        const profileData = profileRes.data;
        const pedidosData = pedidosRes.data || [];

        // --- MUDANÇA PRINCIPAL AQUI ---
        const modalHTML = `
            <div class="modal-header">
                <div style="display:flex; align-items:center; gap:1rem;">
                    <img src="${profileData.foto_url || 'https://i.pravatar.cc/150'}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                    <h2>${profileData.nome || 'Usuário Sem Nome'}</h2>
                </div>
                <button type="button" class="btn-icon" onclick="closeModal()"><i data-feather="x"></i></button>
            </div>
            
            <div class="modal-submenu" style="display:flex; justify-content: space-between; align-items: center; border-bottom:1px solid var(--border-color); padding-bottom:1rem; margin-bottom:1rem;">
                <div style="display:flex; gap:0.5rem;">
                    <button id="btn-tab-profile" class="btn btn-secondary btn-sm active" onclick="showUserModalTab('profile')">Perfil</button>
                    <button id="btn-tab-pedidos" class="btn btn-secondary btn-sm" onclick="showUserModalTab('pedidos')">Pedidos</button>
                </div>
                 <button class="btn btn-primary btn-sm" onclick="openEditUserForm('${profileData.id}')">Editar Perfil</button>
            </div>

            <div class="modal-body">
                <div id="user-modal-tab-profile" style="display: block;">
                    ${renderProfileTab(profileData)}
                </div>
                <div id="user-modal-tab-pedidos" style="display: none;">
                    ${renderPedidosTab(pedidosData)}
                </div>
            </div>
        `;

        document.getElementById('modal-content').innerHTML = modalHTML;
        feather.replace();

    } catch (error) {
        showNotification('Erro ao carregar dados do usuário: ' + error.message, 'error');
        closeModal();
    }
}

        function showUserModalTab(tabName) {
    // Esconde todas as abas de conteúdo
    document.getElementById('user-modal-tab-profile').style.display = 'none';
    document.getElementById('user-modal-tab-pedidos').style.display = 'none';

    // Remove a classe 'active' de todos os botões de aba
    document.getElementById('btn-tab-profile').classList.remove('active');
    document.getElementById('btn-tab-pedidos').classList.remove('active');
    
    // Mostra a aba de conteúdo correta e ativa o botão correspondente
    document.getElementById(`user-modal-tab-${tabName}`).style.display = 'block';
    document.getElementById(`btn-tab-${tabName}`).classList.add('active');
}

        async function openEditUserForm(userId) {
    showModal('<h2>Carregando dados para edição...</h2>');

    try {
        // Busca os dados mais recentes do perfil do usuário
        const { data: profile, error } = await _supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();

        if (error) throw error;

        // Gera o HTML do formulário, já preenchido com os dados do usuário
        const formHTML = `
            <div class="modal-header">
                <h2>Editar Perfil de ${profile.nome || 'Usuário'}</h2>
                <button type="button" class="btn-icon" onclick="closeModal()"><i data-feather="x"></i></button>
            </div>
            
            <form id="edit-user-form" onsubmit="event.preventDefault(); saveEditedUser('${profile.id}')">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-nome">Nome Completo</label>
                        <input type="text" id="edit-nome" value="${profile.nome || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-email">Email</label>
                        <input type="email" id="edit-email" value="${profile.email || ''}" required disabled>
                        <small style="color: var(--text-secondary); margin-top:4px;">O email não pode ser alterado.</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-telefone">Telefone</label>
                        <input type="tel" id="edit-telefone" value="${profile.telefone || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-empresa">Empresa</label>
                        <input type="text" id="edit-empresa" value="${profile.empresa || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-cnpj">CNPJ</label>
                        <input type="text" id="edit-cnpj" value="${profile.cnpj || ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-cep">CEP</label>
                        <input type="text" id="edit-cep" value="${profile.cep || ''}">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="edit-logradouro">Logradouro (Rua/Av)</label>
                        <input type="text" id="edit-logradouro" value="${profile.logradouro || ''}">
                    </div>
                     <div class="form-group">
                        <label for="edit-numero">Número</label>
                        <input type="text" id="edit-numero" value="${profile.numero || ''}">
                    </div>
                     <div class="form-group">
                        <label for="edit-bairro">Bairro</label>
                        <input type="text" id="edit-bairro" value="${profile.bairro || ''}">
                    </div>
                     <div class="form-group">
                        <label for="edit-cidade">Cidade</label>
                        <input type="text" id="edit-cidade" value="${profile.cidade || ''}">
                    </div>
                     <div class="form-group">
                        <label for="edit-uf">UF</label>
                        <input type="text" id="edit-uf" value="${profile.uf || ''}" maxlength="2">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="openUserDetailModal('${profile.id}')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        `;

        // Exibe o modal com o formulário
        showModal(formHTML);
        feather.replace();

    } catch (error) {
        showNotification('Erro ao carregar dados para edição: ' + error.message, 'error');
        closeModal();
    }
}


        async function saveEditedUser(userId) {
    // Coleta todos os valores dos campos do formulário
    const updatedProfileData = {
        nome: document.getElementById('edit-nome').value,
        telefone: document.getElementById('edit-telefone').value,
        empresa: document.getElementById('edit-empresa').value,
        cnpj: document.getElementById('edit-cnpj').value,
        cep: document.getElementById('edit-cep').value,
        logradouro: document.getElementById('edit-logradouro').value,
        numero: document.getElementById('edit-numero').value,
        bairro: document.getElementById('edit-bairro').value,
        cidade: document.getElementById('edit-cidade').value,
        uf: document.getElementById('edit-uf').value
    };

    showModal('<h2>Salvando alterações...</h2>');

    try {
        // Envia os dados atualizados para a tabela 'profiles' do Supabase
        const { error } = await _supabase
            .from('profiles')
            .update(updatedProfileData)
            .eq('id', userId);

        if (error) throw error;

        showNotification('Perfil atualizado com sucesso!', 'success');
        
        // Recarrega o modal de detalhes para mostrar os dados atualizados
        await openUserDetailModal(userId); 
        // Atualiza a tabela principal de usuários em segundo plano
        loadAndRenderUsers(); 

    } catch (error) {
        showNotification('Erro ao salvar as alterações: ' + error.message, 'error');
    }
}
        
        document.addEventListener('DOMContentLoaded', () => {
            
            const state = {
                data: { produtos: [], categorias: [], personalizacao: { heroAtivo: false, heroBanners: [] } },
                originalData: {},
                apiUrl: 'https://cajuia.onrender.com/backend_cajuia.json',
                updateUrl: 'https://cajuia.onrender.com/atualizar-json' 
            };

            const init = async () => {
    await startLoadingAnimation();

    // Pergunta ao Supabase se existe uma sessão ativa
    const { data: { session } } = await _supabase.auth.getSession();

    if (session) {
        // SE EXISTIR SESSÃO:
        console.log('Sessão encontrada! Logado como:', session.user.email);
        
        // 1. Carrega os dados da loja
        await fetchData(); 
        
        // 2. Esconde a tela de login e mostra o painel
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('app-wrapper').style.opacity = '1';
        
        // 3. Carrega dados específicos do usuário (se necessário)
        loadAndRenderUsers(); 
        
    } else {
        // SE NÃO EXISTIR SESSÃO:
        console.log('Nenhuma sessão encontrada. Exibindo tela de login.');
        // A tela de login já é visível por padrão, então não fazemos nada.
    }

    // Finaliza a tela de carregamento e configura os eventos
    finishLoading();
    setupEventListeners();
};

            const fetchData = async () => {
                try {
                    const response = await fetch(`${state.apiUrl}?t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('Falha na rede');
                    const data = await response.json();

                    console.log('Dados recebidos do backend:', data);
                    if (!data.produtos || !Array.isArray(data.produtos)) {
                        showNotification('Backend não retornou array de produtos.', 'error');
                        throw new Error('Backend não retornou array de produtos.');
                    }

                    data.personalizacao = data.personalizacao || { heroAtivo: false, heroBanners: [] };
                    data.personalizacao.heroBanners = data.personalizacao.heroBanners || [];

                    state.data = data;

                    // Ensure mandatory fields in all products
                    state.data.produtos.forEach(prod => {
                        if (!('variacoes' in prod)) prod.variacoes = { tamanhos: [], cores: [] };
                        if (!('estoque' in prod)) prod.estoque = {};
                        if (!('habilitarTamanhos' in prod)) prod.habilitarTamanhos = true;
                        if (!('habilitarCores' in prod)) prod.habilitarCores = true;
                        if (!('imagensVariacoes' in prod)) prod.imagensVariacoes = ["", "", ""];
                        if (!('precoPromocional' in prod)) prod.precoPromocional = null;
                        if (!('mostrarPrecoPromocional' in prod)) prod.mostrarPrecoPromocional = false;
                        if (!('precoPromocionalAtivo' in prod)) prod.precoPromocionalAtivo = false;
                        if (!Array.isArray(prod.imagensVariacoes)) prod.imagensVariacoes = ["", "", ""];
                        while (prod.imagensVariacoes.length < 3) prod.imagensVariacoes.push("");
                    });

                    state.originalData = JSON.parse(JSON.stringify(data));
                    try {
                        renderAll();
                    } catch (e) {
                        console.error('Erro ao renderizar:', e);
                        showNotification('Erro ao renderizar: ' + e.message, 'error');
                    }
                } catch (error) {
                    showNotification('Erro ao carregar os dados. Verifique a conexão ou o backend.', 'error');
                    
                }
            };
            
            const startLoadingAnimation = () => {
                return new Promise(resolve => {
                    const texts = Array.from(document.querySelectorAll('.loading-texts p'));
                    const bar = document.getElementById('loading-bar');
                    let currentTextIndex = 0;
                    
                    const showNextText = () => {
                        texts.forEach((p, index) => p.classList.toggle('visible', index === currentTextIndex));
                        const progress = currentTextIndex >= texts.length ? 100 : (((currentTextIndex + 1) / texts.length) * 100);
                        bar.style.width = `${progress}%`;
                        
                        if (currentTextIndex >= texts.length) {
                            clearInterval(window.loadingInterval);
                            setTimeout(resolve, 1500); // Wait a bit after 100%
                        }
                        currentTextIndex++;
                    };
                    
                    showNextText();
                    window.loadingInterval = setInterval(showNextText, 1000);
                });
            };
            
            const finishLoading = () => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    // The app-wrapper will be shown after successful login.
                    setTimeout(() => {
                        if (loadingScreen) loadingScreen.style.display = 'none';
                    }, 500);
                }
            };
            
            const renderAll = () => {
                renderProductsTable();
                renderCategoriesTable();
                renderPersonalizacaoView();
                // Users table is rendered separately on tab activation
                checkForChanges();
                feather.replace(); // Render icons after content is loaded
            };

            async function loadAndRenderUsers() {
    console.log('Iniciando busca de usuários com filtros...');
    const searchTerm = document.getElementById('user-search-input').value;
    const sortValue = document.getElementById('user-sort-select').value.split(','); // Ex: "criado_em,desc"

    const sortColumn = sortValue[0];
    const sortAscending = sortValue[1] === 'asc';

    // Inicia a construção da query no Supabase
    let query = _supabase.from('profiles').select('*');

    // Se o campo de pesquisa tiver algum texto, adiciona o filtro
    if (searchTerm) {
        // Usa .or() para buscar em múltiplas colunas (nome OU email)
        // Usa .ilike() para busca "case-insensitive" (não diferencia maiúsculas de minúsculas)
        query = query.or(`nome.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
    }

    // Adiciona a ordenação à query
    query = query.order(sortColumn, { ascending: sortAscending });

    // Executa a query construída
    const { data, error } = await query;

    if (error) {
        showNotification('Erro ao buscar usuários: ' + error.message, 'error');
        renderUsersTable([]); // Mostra a tabela vazia em caso de erro
        return;
    }
    
    // Renderiza a tabela com os dados filtrados e ordenados
    renderUsersTable(data); 
    feather.replace();
}

            function renderProductsTable() {
                const tbody = document.getElementById('products-table-body');
                tbody.innerHTML = '';
                state.data.produtos.forEach(prod => {
                    const categoria = state.data.categorias.find(cat => cat.id === prod.categoriaId);
                    tbody.innerHTML += `
                        <tr data-id="${prod.id}">
                            <td>
                                <img src="${prod.imagem}" class="product-image-sm" alt="Produto">
                                ${prod.nome}
                            </td>
                            <td>${categoria ? categoria.nome : '-'}</td>
                            <td>R$ ${prod.preco.toFixed(2)}</td>
                            <td><span style="color:${prod.disponivel ? 'var(--success-color)' : 'var(--danger-color)'};font-weight:bold">${prod.disponivel ? 'Ativo' : 'Inativo'}</span></td>
                            <td class="actions-cell">
                                <button class="btn-icon btn-edit-product" title="Editar"><i data-feather="edit"></i></button>
                                <button class="btn-icon btn-delete-product" title="Excluir"><i data-feather="trash-2"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }

            function renderCategoriesTable() {
                const tbody = document.getElementById('categories-table-body');
                tbody.innerHTML = '';
                state.data.categorias.forEach(cat => {
                    tbody.innerHTML += `
                        <tr data-id="${cat.id}">
                            <td><img src="${cat.icone}" class="product-image-sm" alt="Ícone"></td>
                            <td>${cat.nome}</td>
                            <td class="actions-cell">
                                <button class="btn-icon btn-edit-category" title="Editar"><i data-feather="edit"></i></button>
                                <button class="btn-icon btn-delete-category" title="Excluir"><i data-feather="trash-2"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }

            function renderUsersTable(users) {
                console.log('Renderizando usuários:', users);
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhum usuário encontrado.</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    tbody.innerHTML += `
                        <tr data-id="${user.id}">
                            <td>
                                <span class="user-link" 
                                    onclick="openUserDetailModal('${user.id}')">
                                    ${user.nome || 'N/A'}
                                </span>
                            </td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${user.telefone || 'N/A'}</td>
                            <td>${user.empresa || 'N/A'}</td>
                            <td>${user.cnpj || 'N/A'}</td>
                            <td class="actions-cell">
                                <button class="btn-icon btn-delete-user" title="Excluir"><i data-feather="trash-2"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }

            const renderPersonalizacaoView = () => {
                const { heroAtivo, heroBanners } = state.data.personalizacao;
                document.getElementById('hero-active-toggle').checked = heroAtivo;

                const bannerList = document.getElementById('banner-list');
                bannerList.innerHTML = '';
                if (heroBanners.length === 0) {
                    bannerList.innerHTML = `<p style="text-align:center; color:var(--text-secondary); padding:1rem;">Nenhum slide de banner adicionado.</p>`;
                }
                heroBanners.forEach((banner, index) => {
                    const item = document.createElement('div');
                    item.className = 'banner-item';
                    item.innerHTML = `
                        <img src="${banner.imagemFundo}" class="banner-item-img" alt="Preview">
                        <p class="banner-item-title">${banner.titulo || 'Sem Título'}</p>
                        <div class="banner-item-actions">
                            <button class="btn-icon btn-move-banner" data-index="${index}" data-direction="up" title="Mover para Cima" ${index === 0 ? 'disabled' : ''}>
                                <i data-feather="arrow-up"></i>
                            </button>
                            <button class="btn-icon btn-move-banner" data-index="${index}" data-direction="down" title="Mover para Baixo" ${index === heroBanners.length - 1 ? 'disabled' : ''}>
                                <i data-feather="arrow-down"></i>
                            </button>
                            <button class="btn-icon btn-edit-banner" data-id="${banner.id}" title="Editar">
                                <i data-feather="edit"></i>
                            </button>
                            <button class="btn-icon btn-delete-banner" data-id="${banner.id}" title="Excluir">
                                <i data-feather="trash-2"></i>
                            </button>
                        </div>
                    `;
                    bannerList.appendChild(item);
                });
                updatePreviewCarousel();
                feather.replace(); // Render icons after banner list is updated
            };
            
            let currentPreviewSlide = 0;
            const updatePreviewCarousel = () => {
                const { heroAtivo, heroBanners } = state.data.personalizacao;
                const wrapper = document.getElementById('preview-carousel-wrapper');
                const dots = document.getElementById('preview-carousel-dots');
                wrapper.innerHTML = '';
                dots.innerHTML = '';
                
                if (!heroAtivo || heroBanners.length === 0) {
                    wrapper.innerHTML = `<div class="hero-banner-slide" style="background: var(--bg-color); align-items:center; justify-content:center; color: var(--text-secondary); font-family: var(--font-family-sans); font-size:1.1rem; text-align:center;">
                        <i data-feather="slash" style="width:40px; height:40px; margin-bottom:1rem; color:var(--text-secondary);"></i>
                        Banner Desativado ou Sem Slides
                    </div>`;
                    currentPreviewSlide = 0; // Reset slide index
                    return;
                }

                heroBanners.forEach((slide, index) => {
                    const slideEl = document.createElement('div');
                    slideEl.className = 'hero-banner-slide';
                    slideEl.style.backgroundImage = `url('${slide.imagemFundo}')`;
                    slideEl.innerHTML = `
                        <div>
                            <h1>${slide.titulo || 'Título do Banner'}</h1>
                            <span>${slide.desconto || '50% OFF'}</span>
                            <p>${slide.subtitulo || 'Subtítulo atraente para seu cliente.'}</p>
                        </div>`;
                    wrapper.appendChild(slideEl);

                    const dotEl = document.createElement('span');
                    dotEl.className = 'dot';
                    if(index === currentPreviewSlide) dotEl.classList.add('active');
                    dots.appendChild(dotEl);
                });

                // Update wrapper position for carousel effect
                wrapper.style.transform = `translateX(-${currentPreviewSlide * 100}%)`;

                // Auto-advance carousel
                clearInterval(window.previewCarouselInterval);
                if (heroBanners.length > 1) {
                    window.previewCarouselInterval = setInterval(() => {
                        currentPreviewSlide = (currentPreviewSlide + 1) % heroBanners.length;
                        wrapper.style.transform = `translateX(-${currentPreviewSlide * 100}%)`;
                        dots.querySelectorAll('.dot').forEach((dot, idx) => {
                            dot.classList.toggle('active', idx === currentPreviewSlide);
                        });
                    }, 3000); // Change slide every 3 seconds
                }
                feather.replace(); // Render icons for the "Banner Desativado" state
            };


            const setupEventListeners = () => {
                console.log('setupEventListeners rodou');
                // Mobile Menu Toggle
                document.getElementById('mobile-menu-button').addEventListener('click', () => {
                    document.getElementById('app-wrapper').classList.toggle('sidebar-open');
                });
                document.getElementById('modal-backdrop').addEventListener('click', e => { 
                    if (e.target.id === 'modal-backdrop') {
                        closeModal(); 
                        document.getElementById('app-wrapper').classList.remove('sidebar-open'); // Close sidebar if open
                    }
                });


                // Main Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelector('.nav-link.active').classList.remove('active');
                        e.currentTarget.classList.add('active');
                        const viewId = e.currentTarget.dataset.view;
                        document.querySelectorAll('#main-content > section').forEach(s => s.style.display = 'none');
                        document.getElementById(viewId).style.display = 'block';

                        // Close mobile sidebar on nav click
                        document.getElementById('app-wrapper').classList.remove('sidebar-open');

                        if (viewId === 'users-view') {
                            loadAndRenderUsers();
                        }
                        feather.replace(); // Re-render icons on tab change
                    });
                });

                // Save buttons
                document.getElementById('btn-save-all').addEventListener('click', saveAllDataToServer);
                document.getElementById('btn-save-all-cat').addEventListener('click', saveAllDataToServer);
                document.getElementById('btn-save-all-custom').addEventListener('click', saveAllDataToServer);

                // New item buttons
                document.getElementById('btn-new-product').addEventListener('click', () => openProductModal());
                document.getElementById('btn-new-category').addEventListener('click', () => openCategoryModal());
                document.getElementById('btn-new-banner').addEventListener('click', () => openBannerModal());

                // Personalization Listeners
                document.getElementById('hero-active-toggle').addEventListener('change', e => {
                    state.data.personalizacao.heroAtivo = e.target.checked;
                    updatePreviewCarousel();
                    checkForChanges();
                });
                
                document.getElementById('banner-list').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    if(button.classList.contains('btn-edit-banner')) {
                        openBannerModal(parseInt(button.dataset.id));
                    }
                    if(button.classList.contains('btn-delete-banner')) {
                        openDeleteConfirmation('banner', parseInt(button.dataset.id));
                    }
                    if(button.classList.contains('btn-move-banner')) {
                        moveBanner(parseInt(button.dataset.index), button.dataset.direction);
                    }
                });

                // Table Listeners (Products and Categories)
                const handleTableClick = (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const id = parseInt(button.closest('tr').dataset.id);
                    if (button.classList.contains('btn-edit-product')) openProductModal(id);
                    if (button.classList.contains('btn-delete-product')) openDeleteConfirmation('product', id);
                    if (button.classList.contains('btn-edit-category')) openCategoryModal(id);
                    if (button.classList.contains('btn-delete-category')) openDeleteConfirmation('category', id);
                };
                document.querySelector('#products-table-body').addEventListener('click', handleTableClick);
                document.querySelector('#categories-table-body').addEventListener('click', handleTableClick);
                
                // User table delete and refresh
                document.getElementById('users-table-body').addEventListener('click', (e) => {
    const button = e.target.closest('.btn-delete-user');
    if (!button) return;

    // Encontra o nome do usuário na própria linha da tabela para a mensagem de confirmação
    const row = button.closest('tr');
    const userId = row.dataset.id;
    const userName = row.cells[0].innerText; // Pega o texto da primeira célula (Nome)

    // Chama a função de confirmação que já criamos, que por sua vez chama deleteUser()
    confirmDeleteUser(userId, userName);
});
                document.getElementById('btn-apply-filters').addEventListener('click', loadAndRenderUsers);
            };
            
            // Modal Functions (Banner)
            const openBannerModal = (id = null) => {
                const isEditing = id !== null;
                const banner = isEditing ? state.data.personalizacao.heroBanners.find(b => b.id === id) : { id: Date.now(), titulo: '', desconto: '', subtitulo: '', imagemFundo: ''};
                
                const modalHTML = `
                    <div class="modal-header">
                        <h2>${isEditing ? 'Editar Slide do Carrossel' : 'Novo Slide de Carrossel'}</h2>
                        <button type="button" class="btn-icon" id="close-modal-btn"><i data-feather="x"></i></button>
                    </div>
                    <form id="banner-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="banner-titulo">Título</label><input type="text" id="banner-titulo" value="${banner.titulo}" placeholder="Ex: Nova Coleção" required></div>
                            <div class="form-group"><label for="banner-desconto">Destaque (Ex: 30% OFF)</label><input type="text" id="banner-desconto" value="${banner.desconto}" placeholder="Ex: IMPERDÍVEL"></div>
                            <div class="form-group" style="grid-column: 1 / -1;"><label for="banner-subtitulo">Subtítulo</label><input type="text" id="banner-subtitulo" value="${banner.subtitulo}" placeholder="Ex: Peças exclusivas para você"></div>
                            <div class="form-group" style="grid-column: 1 / -1;"><label for="banner-imagem">URL da Imagem de Fundo</label><input type="url" id="banner-imagem" value="${banner.imagemFundo}" placeholder="https://exemplo.com/imagem.jpg" required></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancel-modal-btn">Cancelar</button>
                            <button type="submit" class="btn btn-primary">${isEditing ? 'Salvar Alterações' : 'Adicionar Slide'}</button>
                        </div>
                    </form>`;
                showModal(modalHTML);
                document.getElementById('banner-form').addEventListener('submit', e => handleBannerFormSubmit(e, banner.id));
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            };

            const handleBannerFormSubmit = (e, id) => {
                e.preventDefault();
                const isEditing = state.data.personalizacao.heroBanners.some(b => b.id === id);
                const updatedBanner = {
                    id: id,
                    titulo: document.getElementById('banner-titulo').value,
                    desconto: document.getElementById('banner-desconto').value,
                    subtitulo: document.getElementById('banner-subtitulo').value,
                    imagemFundo: document.getElementById('banner-imagem').value,
                };

                if (isEditing) {
                    const index = state.data.personalizacao.heroBanners.findIndex(b => b.id === id);
                    state.data.personalizacao.heroBanners[index] = updatedBanner;
                } else {
                    state.data.personalizacao.heroBanners.push(updatedBanner);
                }
                renderPersonalizacaoView();
                closeModal();
                showNotification(`Slide ${isEditing ? 'atualizado' : 'criado'}! ✨`);
                checkForChanges();
            };

            // Banner Movement
            const moveBanner = (index, direction) => {
                const banners = state.data.personalizacao.heroBanners;
                if (direction === 'up' && index > 0) {
                    [banners[index], banners[index - 1]] = [banners[index - 1], banners[index]];
                } else if (direction === 'down' && index < banners.length - 1) {
                    [banners[index], banners[index + 1]] = [banners[index + 1], banners[index]];
                }
                renderPersonalizacaoView();
                checkForChanges();
                showNotification('Slide movido! ↕️');
            };

            // Generic Delete Confirmation
            const openDeleteConfirmation = (type, id) => {
                let itemName = '';
                if (type === 'product') itemName = state.data.produtos.find(p => p.id === id)?.nome;
                else if (type === 'category') itemName = state.data.categorias.find(c => c.id === id)?.nome;
                else if (type === 'banner') itemName = state.data.personalizacao.heroBanners.find(b => b.id === id)?.titulo;
                
                const modalHTML = `
                    <div class="modal-header">
                        <h2>Confirmar Exclusão</h2>
                        <button type="button" class="btn-icon" id="close-modal-btn"><i data-feather="x"></i></button>
                    </div>
                    <p style="text-align: center; margin-bottom: 2rem; color: var(--text-primary);">Você tem certeza que deseja excluir <strong>"${itemName}"</strong>? Esta ação não pode ser desfeita.</p>
                    <div class="modal-footer">
                        <button id="cancel-delete" class="btn btn-secondary">Cancelar</button>
                        <button id="confirm-delete" class="btn btn-danger">Excluir</button>
                    </div>`;
                showModal(modalHTML);
                document.getElementById('cancel-delete').addEventListener('click', closeModal);
                document.getElementById('confirm-delete').addEventListener('click', () => handleDelete(type, id));
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            };
            
            const handleDelete = (type, id) => {
                if (type === 'product') state.data.produtos = state.data.produtos.filter(p => p.id !== id);
                else if (type === 'category') state.data.categorias = state.data.categorias.filter(c => c.id !== id);
                else if (type === 'banner') state.data.personalizacao.heroBanners = state.data.personalizacao.heroBanners.filter(b => b.id !== id);
                
                renderAll();
                closeModal();
                showNotification('Item excluído com sucesso! 🗑️');
                checkForChanges();
            };

            const checkForChanges = () => {
                const hasChanged = JSON.stringify(state.data) !== JSON.stringify(state.originalData);
                document.querySelectorAll('#btn-save-all, #btn-save-all-cat, #btn-save-all-custom').forEach(btn => btn.disabled = !hasChanged);
            };

            const saveAllDataToServer = async () => {
                const buttons = document.querySelectorAll('#btn-save-all, #btn-save-all-cat, #btn-save-all-custom');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.innerHTML; // Store full HTML
                    btn.innerHTML = `<i data-feather="loader" class="feather-spin"></i> Salvando...`;
                    feather.replace(); // Render spinning icon
                });

                try {
                    const response = await fetch(state.updateUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state.data)
                    });
                    if (!response.ok) throw new Error('Falha ao salvar no servidor. Tente novamente.');
                    
                    state.originalData = JSON.parse(JSON.stringify(state.data));
                    showNotification('Alterações salvas com sucesso! ✅');
                } catch (error) {
                    showNotification('Erro ao salvar: ' + error.message, 'error');
                } finally {
                    buttons.forEach(btn => {
                        btn.innerHTML = btn.dataset.originalText; // Restore original HTML
                        feather.replace(); // Re-render icons after restore
                    });
                    checkForChanges();
                }
            };

            // Category Modal
            const openCategoryModal = (id = null) => {
                const isEditing = id !== null;
                const category = isEditing ? state.data.categorias.find(c => c.id === id) : { nome: '', icone: '' };
                const modalHTML = `
                    <div class="modal-header">
                        <h2>${isEditing ? 'Editar Categoria' : 'Nova Categoria'}</h2>
                        <button type="button" class="btn-icon" id="close-modal-btn"><i data-feather="x"></i></button>
                    </div>
                    <form id="category-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="nome">Nome da Categoria</label><input type="text" id="nome" value="${category.nome}" required placeholder="Ex: Frutas Frescas"></div>
                            <div class="form-group"><label for="icone">URL do Ícone (SVG ou PNG)</label><input type="url" id="icone" value="${category.icone}" required placeholder="https://exemplo.com/icone.svg"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancel-modal-btn">Cancelar</button>
                            <button type="submit" class="btn btn-primary">${isEditing ? 'Salvar Alterações' : 'Criar Categoria'}</button>
                        </div>
                    </form>`;
                showModal(modalHTML);
                document.getElementById('category-form').addEventListener('submit', e => handleCategoryFormSubmit(e, id));
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            };

            const handleCategoryFormSubmit = (e, id) => {
                e.preventDefault();
                const isEditing = id !== null;
                const updatedCategory = { id: isEditing ? id : Date.now(), nome: document.getElementById('nome').value, icone: document.getElementById('icone').value };
                if (isEditing) state.data.categorias[state.data.categorias.findIndex(c => c.id === id)] = updatedCategory;
                else state.data.categorias.push(updatedCategory);
                renderAll();
                closeModal();
                showNotification(`Categoria ${isEditing ? 'atualizada' : 'criada'}! ✅`);
                checkForChanges();
            };

            // Product Modal
            const openProductModal = (id = null) => {
                const isEditing = id !== null;
                const product = isEditing ? state.data.produtos.find(p => p.id === id) : {
                    nome: '', descricao: '', preco: 0, disponivel: true, imagem: '', categoriaId: state.data.categorias[0]?.id || '',
                    variacoes: { tamanhos: ['P', 'M', 'G'], cores: [] }, // Default sizes
                    habilitarTamanhos: true,
                    habilitarCores: true,
                    imagensVariacoes: ["", "", ""], // 3 variation image slots
                    precoPromocional: null,
                    mostrarPrecoPromocional: false,
                    precoPromocionalAtivo: false,
                    estoque: { P: 0, M: 0, G: 0 } // Default stock for sizes
                };
                
                // Ensure new properties exist for old products
                if (!('habilitarTamanhos' in product)) product.habilitarTamanhos = true;
                if (!('habilitarCores' in product)) product.habilitarCores = true;
                if (!('imagensVariacoes' in product)) product.imagensVariacoes = ["", "", ""];
                if (!('precoPromocional' in product)) product.precoPromocional = null;
                if (!('mostrarPrecoPromocional' in product)) product.mostrarPrecoPromocional = false;
                if (!('precoPromocionalAtivo' in product)) product.precoPromocionalAtivo = false;
                while (product.imagensVariacoes.length < 3) product.imagensVariacoes.push(""); // Ensure 3 slots

                const categoriesOptions = state.data.categorias.map(cat => `<option value="${cat.id}" ${cat.id === product.categoriaId ? 'selected' : ''}>${cat.nome}</option>`).join('');
                const imagensVariacoes = product.imagensVariacoes || ["", "", ""];

                const modalHTML = `
                    <div class="modal-header">
                        <h2>${isEditing ? 'Editar Produto' : 'Novo Produto'}</h2>
                        <button type="button" class="btn-icon" id="close-modal-btn"><i data-feather="x"></i></button>
                    </div>
                    <form id="product-form">
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;"><label for="nome">Nome do Produto</label><input type="text" id="nome" value="${product.nome}" required placeholder="Ex: Maçã Gala Orgânica"></div>
                            <div class="form-group" style="grid-column: 1 / -1;"><label for="descricao">Descrição</label><textarea id="descricao" rows="3" placeholder="Detalhes e benefícios do produto...">${product.descricao}</textarea></div>
                            <div class="form-group"><label for="preco">Preço (R$)</label><input type="number" step="0.01" id="preco" value="${product.preco}" required placeholder="9.99"></div>
                            <div class="form-group"><label for="categoriaId">Categoria</label><select id="categoriaId">${categoriesOptions}</select></div>
                            <div class="form-group" style="grid-column: 1 / -1;"><label for="imagem">URL da Imagem Principal</label><input type="url" id="imagem" value="${product.imagem}" required placeholder="https://exemplo.com/produto-principal.jpg"></div>
                            <div class="form-group"><label for="disponivel">Status</label><select id="disponivel"><option value="true" ${product.disponivel ? 'selected' : ''}>Disponível</option><option value="false" ${!product.disponivel ? 'selected' : ''}>Indisponível</option></select></div>
                            <div class="form-group"><label>Habilitar Tamanhos</label>
                                <select id="habilitarTamanhos"><option value="true" ${product.habilitarTamanhos ? 'selected' : ''}>Sim</option><option value="false" ${!product.habilitarTamanhos ? 'selected' : ''}>Não</option></select>
                            </div>
                            <div class="form-group"><label>Habilitar Cores</label>
                                <select id="habilitarCores"><option value="true" ${product.habilitarCores ? 'selected' : ''}>Sim</option><option value="false" ${!product.habilitarCores ? 'selected' : ''}>Não</option></select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Imagens de Variação (opcional)</label>
                                <input type="url" id="imagemVar1" placeholder="URL da Foto 1" value="${imagensVariacoes[0] || ''}" style="margin-bottom:0.5rem;">
                                <input type="url" id="imagemVar2" placeholder="URL da Foto 2" value="${imagensVariacoes[1] || ''}" style="margin-bottom:0.5rem;">
                                <input type="url" id="imagemVar3" placeholder="URL da Foto 3" value="${imagensVariacoes[2] || ''}">
                            </div>
                            <div class="form-group"><label for="precoPromocional">Preço Promocional (R$)</label>
                                <input type="number" step="0.01" id="precoPromocional" value="${product.precoPromocional !== null ? product.precoPromocional : ''}" placeholder="Ex: 7.50">
                            </div>
                            <div class="form-group"><label>Mostrar Preço Promocional</label>
                                <select id="mostrarPrecoPromocional"><option value="true" ${product.mostrarPrecoPromocional ? 'selected' : ''}>Sim</option><option value="false" ${!product.mostrarPrecoPromocional ? 'selected' : ''}>Não</option></select>
                            </div>
                            <div class="form-group"><label>Ativar Preço Promocional</label>
                                <select id="precoPromocionalAtivo"><option value="true" ${product.precoPromocionalAtivo ? 'selected' : ''}>Sim</option><option value="false" ${!product.precoPromocionalAtivo ? 'selected' : ''}>Não</option></select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancel-modal-btn">Cancelar</button>
                            <button type="submit" class="btn btn-primary">${isEditing ? 'Salvar Alterações' : 'Criar Produto'}</button>
                        </div>
                    </form>`;
                showModal(modalHTML);
                document.getElementById('product-form').addEventListener('submit', e => handleProductFormSubmit(e, id));
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            };

            const handleProductFormSubmit = (e, id) => {
                e.preventDefault();
                const isEditing = id !== null;
                const imagensVariacoes = [
                    document.getElementById('imagemVar1').value,
                    document.getElementById('imagemVar2').value,
                    document.getElementById('imagemVar3').value
                ].filter(url => url !== ''); // Filter out empty URLs

                const product = {
                    id: isEditing ? id : Date.now(),
                    nome: document.getElementById('nome').value,
                    descricao: document.getElementById('descricao').value,
                    preco: parseFloat(document.getElementById('preco').value),
                    categoriaId: parseInt(document.getElementById('categoriaId').value),
                    imagem: document.getElementById('imagem').value,
                    disponivel: document.getElementById('disponivel').value === 'true',
                    // Keep existing variations and stock if editing, or default if new
                    variacoes: isEditing ? (state.data.produtos.find(p=>p.id===id).variacoes || {tamanhos:[], cores:[]}) : {tamanhos:['P','M','G'], cores:[]},
                    estoque: isEditing ? (state.data.produtos.find(p=>p.id===id).estoque || {}) : {P:0, M:0, G:0},
                    habilitarTamanhos: document.getElementById('habilitarTamanhos').value === 'true',
                    habilitarCores: document.getElementById('habilitarCores').value === 'true',
                    imagensVariacoes: imagensVariacoes,
                    precoPromocional: document.getElementById('precoPromocional').value !== '' ? parseFloat(document.getElementById('precoPromocional').value) : null,
                    mostrarPrecoPromocional: document.getElementById('mostrarPrecoPromocional').value === 'true',
                    precoPromocionalAtivo: document.getElementById('precoPromocionalAtivo').value === 'true'
                };
                if (isEditing) state.data.produtos[state.data.produtos.findIndex(p => p.id === id)] = product;
                else state.data.produtos.push(product);
                renderAll();
                closeModal();
                showNotification(`Produto ${isEditing ? 'atualizado' : 'criado'}! ✅`);
                checkForChanges();
            };

            // Global listeners for change detection
            document.body.addEventListener('input', () => setTimeout(checkForChanges, 50));
            document.body.addEventListener('click', (e) => {
                // Check for actions that modify state
                if (e.target.closest('.btn-delete-product, .btn-delete-category, .btn-delete-banner, .btn-move-banner')) {
                    setTimeout(checkForChanges, 100);
                }
            });
            document.body.addEventListener('submit', () => setTimeout(checkForChanges, 100));

            init();
        });
    </script>
</body>
</html>
