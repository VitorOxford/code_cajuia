<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iterate - A Rede Social do Processo Criativo</title>

    <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.10.4/dist/emoji-picker-element.umd.min.js"></script>

    <!-- Vue Flow (para a nova árvore de evolução) -->
    <script src="https://unpkg.com/@vue-flow/core@1.33.5/dist/vue-flow.min.js"></script>
    <script src="https://unpkg.com/@vue-flow/controls@1.1.2/dist/vue-flow.controls.js"></script>
    <script src="https://unpkg.com/@vue-flow/minimap@1.4.0/dist/vue-flow.minimap.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@vue-flow/core@1.33.5/dist/style.css">
    <link rel="stylesheet" href="https://unpkg.com/@vue-flow/controls@1.1.2/dist/style.css">
    <link rel="stylesheet" href="https://unpkg.com/@vue-flow/minimap@1.4.0/dist/style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111111; color: #E5E7EB; }
        :root { --accent-color: #3B82F6; --accent-color-hover: #2563EB; --danger-color: #EF4444; --danger-color-hover: #DC2626; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background-color: var(--accent-color); transition: background-color 0.2s; color: white; font-weight: 600; border-radius: 0.5rem; padding: 0.75rem 1.5rem; }
        .btn-primary:hover { background-color: var(--accent-color-hover); }
        .canvas-container { width: 100% !important; height: 100% !important; }
        .post-login-loader { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #1a1a1a; overflow: hidden; }
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .particle { position: absolute; background-color: rgba(59, 130, 246, 0.2); border-radius: 50%; animation: move-particle 25s linear infinite; }
        @keyframes move-particle { 0% { transform: translate(0, 0); } 100% { transform: translate(100vw, 100vh); } }
        .loading-bar-container { width: 250px; height: 8px; background-color: #333; border-radius: 4px; overflow: hidden; margin-top: 2rem; }
        .loading-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #3B82F6, #9333ea, #EC4899); border-radius: 4px; animation: fill-bar 7s ease-out forwards; }
        @keyframes fill-bar { from { width: 0%; } to { width: 100%; } }
        .animated-texts { margin-top: 0.8rem; height: 30px; position: relative; width: 250px; text-align: center; margin-right:210px; }
        .animated-text { position: absolute; width: 100%; opacity: 0; font-weight: 500; color: #a0a0a0; animation: fade-up-down 2s ease-in-out; }
        @keyframes fade-up-down { 0% { opacity: 0; transform: translateY(20px); } 20% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
        .animated-text:nth-child(1) { animation-delay: 0s; } .animated-text:nth-child(2) { animation-delay: 2s; } .animated-text:nth-child(3) { animation-delay: 4s; } .animated-text:nth-child(4) { animation-delay: 6s; font-weight: 700; color: #fff; }
        
        /* Estilos para a Árvore de Evolução */
        .tree-node { position: relative; padding-left: 30px; }
        .tree-node-content { border-radius: 12px; margin-bottom: 1rem; }
        .tree-branch { position: absolute; top: 50px; left: 10px; width: 20px; height: calc(100% - 40px); border-left: 2px solid #4B5563; }
        .tree-branch-entry { position: absolute; top: 50px; left: 10px; width: 20px; height: 2px; background-color: #4B5563; }
   
   @keyframes pulse-logo {
  0% { transform: scale(1); }
  50% { transform: scale(1.08); }
  100% { transform: scale(1); }
}
.pulse-logo {
  animation: pulse-logo 1.6s;
}

@keyframes spin-fav {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
.spin-fav {
  animation: spin-fav 0.7s cubic-bezier(.4,2,.6,1) 1;
}

.fav-glow {
  filter: drop-shadow(0 0 8px #fde047) drop-shadow(0 0 16px #fde047);
  color: #fde047 !important;
  transition: filter 0.4s, color 0.4s;
  animation: fav-glow-fade 1.2s forwards;
}
@keyframes fav-glow-fade {
  0% { filter: drop-shadow(0 0 8px #fde047) drop-shadow(0 0 16px #fde047); color: #fde047; }
  80% { filter: drop-shadow(0 0 8px #fde047) drop-shadow(0 0 16px #fde047); color: #fde047; }
  100% { filter: none; color: #fde047; }
}
.fav-particles {
  pointer-events: none;
  position: absolute;
  left: 50%; top: 50%;
  width: 0; height: 0;
  z-index: 10;
}
.fav-particle {
  position: absolute;
  left: 0; top: 0;
  width: 8px; height: 8px;
  opacity: 0.99;
  color: #fde047;
  filter: drop-shadow(0 0 6px #fde047cc);
  will-change: transform, opacity;
  animation: fav-shower 1.2s cubic-bezier(.4,2,.6,1) forwards;
}
@keyframes fav-shower {
  0% {
    opacity: 0.85;
    transform: scale(var(--scale,1)) translate(0,0);
  }
  60% {
    opacity: 1;
    transform: scale(var(--scale,1.1)) translate(var(--x, 0px), var(--y1, -30px));
  }
  100% {
    opacity: 0;
    transform: scale(var(--scale,0.8)) translate(var(--x, 0px), var(--y2, -70px));
  }
}

nav button .nav-label,
nav button svg {
  transition: color 0.2s, filter 0.2s;
}

/* Seleção Feed/Notificações/Perfil */
.nav-selected svg,
.nav-selected .nav-label {
  color: #2563eb !important;
  filter: drop-shadow(0 0 8px #2563eb) drop-shadow(0 0 16px #a855f7);
}
.nav-selected .nav-label {
  background: linear-gradient(90deg, #2563eb 60%, #a855f7 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Seleção Favoritos */
.nav-selected-yellow svg,
.nav-selected-yellow .nav-label {
  color: #fde047 !important;
  filter: drop-shadow(0 0 8px #fde047) drop-shadow(0 0 16px #facc15);
}
.nav-selected-yellow .nav-label {
  background: linear-gradient(90deg, #fde047 60%, #facc15 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Hover (apenas se não estiver selecionado) */
nav button:hover svg,
nav button:hover .nav-label {
  color: #a855f7;
  filter: drop-shadow(0 0 8px #2563eb88) drop-shadow(0 0 16px #a855f788);
}
nav #nav-favorites:hover svg,
nav #nav-favorites:hover .nav-label {
  color: #fde047;
  filter: drop-shadow(0 0 8px #fde04788) drop-shadow(0 0 16px #facc1588);
}
   </style>  
</head>
<body class="antialiased">

    <div id="app" class="h-screen w-screen overflow-x-hidden">

        <template v-if="isConfigured">
        <notification-toast :message="notification.message" :type="notification.type" v-if="notification.visible"></notification-toast>
        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
          <div class="w-16 h-16 border-4 border-t-transparent border-[var(--accent-color)] rounded-full animate-spin"></div>
        </div>
        <post-login-loader-component v-if="showPostLoginLoader"></post-login-loader-component>
        <div v-else-if="!isLoading && !showPostLoginLoader">
        <div v-if="!session" class="fade-in">
          <auth-component @show-notification="showNotification"></auth-component>
        </div>
        <div v-else class="fade-in h-full">
        <div v-if="currentView === 'feed'" class="h-full">
        <feed-component
          :key="feedKey"
          @create-post="navigateToEditor(null)"
          @iterate-post="navigateToEditor($event)"
          @view-tree="navigateToTree($event)"
          @show-notification="showNotification"
          @logout="handleLogout"
          :user="session.user"
        ></feed-component>
        </div>
                    </div>
                    <div v-if="currentView === 'editor'" class="h-full">
                        <editor-component :post-to-edit="activePost" @back="navigateToFeed" @show-notification="showNotification"></editor-component>
                    </div>
                    <div v-if="currentView === 'tree'" class="h-full">
                         <tree-view-component :root-post-id="activePost.id" @back="navigateToFeed" @iterate-post="navigateToEditor($event)" @show-notification="showNotification"></tree-view-component>
                    </div>
                    <div v-if="currentView === 'favorites'" class="h-full">
                        <favorites-component :user="session.user" @show-notification="showNotification"></favorites-component>
                    </div>
                    <div v-if="currentView === 'profile'" class="h-full">
                        <profile-component :user="session.user"></profile-component>
                    </div>
                </div>
            </div>
        </template>
        <template v-else>
            <config-error-component></config-error-component>
        </template>

    </div>

    <script>
        const { createApp, ref, reactive, onMounted, defineAsyncComponent } = Vue;
        const { createClient } = supabase;

        // =======================================================
        // LÓGICA PRINCIPAL DA APLICAÇÃO VUE (SETUP)
        // =======================================================
        const app = createApp({
            setup() {
                const SUPABASE_URL = 'https://lhppxwgyrzaoabcqrsrg.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxocHB4d2d5cnphb2FiY3Fyc3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0NDQwNjksImV4cCI6MjA2NjAyMDA2OX0.3Hwg8KqQylXE4_G3Nsn4Yrs7_aiz_djqxsneRqODIbM';
                
                const isConfigured = ref(false);
                let supabaseClient = null;
                
                if (SUPABASE_URL !== 'SEU_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'SUA_SUPABASE_ANON_KEY') {
                    isConfigured.value = true;
                    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                    console.error("ERRO: Configure suas credenciais do Supabase no código!");
                }

                const session = ref(null);
                const isLoading = ref(true);
                const showPostLoginLoader = ref(false);
                const currentView = ref('feed'); 
                const activePost = ref(null);
                const notification = reactive({ visible: false, message: '', type: 'success' });

                const feedKey = ref(0);

                onMounted(() => {
                    if (!isConfigured.value) {
                        isLoading.value = false;
                        return;
                    }
                
                    supabaseClient.auth.getSession().then(({ data }) => {
                        session.value = data.session;
                        isLoading.value = false;
                    }).catch(error => {
                        console.error("Erro ao pegar sessão:", error);
                        isLoading.value = false;
                    });

                    supabaseClient.auth.onAuthStateChange((_event, _session) => {
                        const wasLoggedIn = !!session.value;
                        session.value = _session;

                        if (_session && !wasLoggedIn) {
                            showPostLoginLoader.value = true;
                            setTimeout(() => {
                                showPostLoginLoader.value = false;
                                currentView.value = 'feed';
                            }, 7000);
                        } 
                        else if (!_session) {
                            showPostLoginLoader.value = false;
                            currentView.value = 'auth';
                        }
                    });
                });
                
                const handleLogout = async () => {
                    await supabaseClient.auth.signOut();
                };

                const navigateToFeed = () => { 
            feedKey.value++; // <-- Adicione esta linha para incrementar a chave
            currentView.value = 'feed';
                };
                const navigateToEditor = (post) => { activePost.value = post; currentView.value = 'editor'; };
                const navigateToTree = (post) => { activePost.value = post; currentView.value = 'tree'; };

                const showNotification = (message, type = 'success') => {
                    notification.message = message;
                    notification.type = type;
                    notification.visible = true;
                    setTimeout(() => { notification.visible = false; }, 4000);
                };

                return {
            // ADICIONE "feedKey" AO RETORNO:
            isConfigured, session, isLoading, showPostLoginLoader, currentView, 
            activePost, notification, supabase: supabaseClient, handleLogout, 
            navigateToFeed, navigateToEditor, navigateToTree, showNotification,
            feedKey // <-- Adicione aqui
        };
            },
        });

        // =======================================================
        // COMPONENTES DA APLICAÇÃO
        // =======================================================
        
        app.component('NotificationToast', {
            props: ['message', 'type'],
            template: `
                <div class="fixed bottom-5 right-5 z-50 fade-in">
                    <div class="flex items-center px-4 py-3 rounded-lg shadow-lg text-white" :class="type === 'success' ? 'bg-green-500' : 'bg-red-500'">
                        <span class="font-bold mr-2">{{ type === 'success' ? '✓' : '!' }}</span>
                        <span>{{ message }}</span>
                    </div>
                </div>
            `,
        });
        
        app.component('ConfigErrorComponent', {
            template: `
                <div class="h-screen w-screen flex flex-col items-center justify-center bg-red-900/50 p-8 text-center">
                    <h1 class="text-3xl font-bold text-white mb-4">[!] Configuração Necessária</h1>
                    <p class="max-w-xl text-lg text-yellow-100">
                        Por favor, abra o código, procure por <code class="bg-black/50 px-2 py-1 rounded-md font-mono text-white">SEU_SUPABASE_URL</code> e <code class="bg-black/50 px-2 py-1 rounded-md font-mono text-white">SUA_SUPABASE_ANON_KEY</code> e substitua-os com suas chaves reais do painel do Supabase.
                    </p>
                </div>
            `,
        });

        app.component('AuthComponent', {
            emits: ['show-notification'],
            setup(props, { emit }) {
                const isLogin = ref(true);
                const email = ref('');
                const password = ref('');
                const loading = ref(false);

                const handleAuth = async () => {
                    if (!email.value || !password.value) {
                        emit('show-notification', 'Por favor, preencha e-mail e senha.', 'error'); return;
                    }
                    loading.value = true;
                    try {
                        const { error } = isLogin.value
                            ? await window.app.supabase.auth.signInWithPassword({ email: email.value, password: password.value })
                            : await window.app.supabase.auth.signUp({ email: email.value, password: password.value });
                        if (error) throw error;
                        if (!isLogin.value) { emit('show-notification', 'Cadastro realizado! Verifique seu e-mail para confirmação.', 'success'); }
                    } catch (error) {
                        emit('show-notification', error.message || 'Ocorreu um erro.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                return { isLogin, email, password, loading, handleAuth };
            },
            template: `
                <div class="min-h-screen flex flex-col items-center justify-center bg-[#111111] p-4">
                    <div class="w-full max-w-md space-y-8">
                        <div>
                            <img src="https://res.cloudinary.com/dsqpboeky/image/upload/v1750530114/Gemini_Generated_Image_krs9u5krs9u5krs9_1_4_melpei_c_crop_w_750_h_340_kq45l3.png" alt="Logo Iterate" class="w-60 h-30 mx-auto mb-4"> 
                            <p class="mt-2 text-center text-lg text-gray-400">Semeie criações, colha possibilidades.</p>
                        </div>
                        <div class="bg-[#1C1C1C] border border-neutral-800 p-8 rounded-2xl shadow-2xl shadow-black/50">
                            <form class="space-y-6" @submit.prevent="handleAuth">
                                <input v-model="email" type="email" required class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]" placeholder="seu@email.com">
                                <input v-model="password" type="password" required class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]" placeholder="Sua senha">
                                <button type="submit" class="w-full btn-primary flex justify-center items-center gap-2" :disabled="loading">
                                    <div v-if="loading" class="w-5 h-5 border-2 border-t-transparent rounded-full animate-spin"></div>
                                    <span>{{ isLogin ? 'Entrar' : 'Cadastrar' }}</span>
                                </button>
                            </form>
                            <p class="mt-6 text-center text-sm text-gray-400">
                                {{ isLogin ? 'Não tem uma conta?' : 'Já tem uma conta?' }}
                                <a href="#" @click.prevent="isLogin = !isLogin" class="font-medium text-[var(--accent-color)] hover:text-[var(--accent-color-hover)]">
                                    {{ isLogin ? 'Cadastre-se' : 'Faça login' }}
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            `,
        });

        app.component('PostLoginLoaderComponent', {
            setup() {
                 onMounted(() => {
                    const particleContainer = document.querySelector('.particles');
                    if (!particleContainer) return;
                    for (let i = 0; i < 30; i++) {
                        const particle = document.createElement('div');
                        particle.classList.add('particle');
                        const size = Math.random() * 5 + 1;
                        particle.style.width = `${size}px`; particle.style.height = `${size}px`;
                        particle.style.top = `${Math.random() * 100}%`; particle.style.left = `${Math.random() * 100}%`;
                        const duration = Math.random() * 15 + 10;
                        particle.style.animationDuration = `${duration}s`; particle.style.animationDelay = `${Math.random() * 5}s`;
                        particleContainer.appendChild(particle);
                    }
                });
            },
            template: `
                <div class="post-login-loader">
                    <div class="particles"></div>
                    <img src="https://res.cloudinary.com/dsqpboeky/image/upload/v1750452925/Gemini_Generated_Image_krs9u5krs9u5krs9_1_1_lgjvon_c_crop_w_730_h_270_b6vbqm.png" alt="Logo Iterate" class="w-60 h-39 mb-4 fade-in">
                    <div class="loading-bar-container"><div class="loading-bar"></div></div>
                    <div class="animated-texts" style="margin-left:0; text-align:center;">
                        <span class="animated-text">carregando interface...</span>
                        <span class="animated-text">carregando recursos...</span>
                        <span class="animated-text">otimizando experiência...</span>
                        <span class="animated-text">VAMOS CRIAR!</span>
                    </div>
                </div>
            `
        });
 
        const TreeNodeComponent = {
            name: 'TreeNodeComponent',
            props: ['node', 'isLast'],
            emits: ['iterate-post'],
            setup(props, { emit }) {
                const formatDate = (dateString) => {
                    if(!dateString) return '';
                    return new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                };
                return { formatDate, emit };
            },
            template: `
                <div class="tree-node">
                    <div class="tree-branch-entry"></div>
                    <div v-if="!isLast" class="tree-branch"></div>
                    <div class="tree-node-content bg-[#1C1C1C] border border-transparent hover:border-blue-700 transition-colors p-3 flex items-center gap-4">
                        <img v-if="node.canvas_thumbnail_url" :src="node.canvas_thumbnail_url" class="w-16 h-16 rounded-lg bg-neutral-900 object-cover flex-shrink-0"/>
                        <div v-else class="w-16 h-16 rounded-lg bg-neutral-900 flex-shrink-0"></div>
                        <div class="flex-grow">
                            <p class="font-bold text-white">{{ node.user_email }}</p>
                            <p class="text-sm text-neutral-400">Iterou em {{ formatDate(node.created_at) }}</p>
                        </div>
                        <button @click="emit('iterate-post', node)" class="btn-primary px-3 py-1 text-sm">Iterar</button>
                    </div>
                    <div v-if="node.children && node.children.length > 0" class="children-container">
                        <tree-node-component 
                            v-for="(child, index) in node.children" 
                            :key="child.id" 
                            :node="child"
                            :is-last="index === node.children.length - 1"
                            @iterate-post="$emit('iterate-post', $event)"
                        ></tree-node-component>
                    </div>
                </div>
            `
        };
        app.component('TreeNodeComponent', TreeNodeComponent);

        app.component('TreeViewComponent', {
  props: ['rootPostId'],
  emits: ['back', 'iterate-post', 'show-notification'],
  setup(props, { emit }) {
    const treeData = ref(null);
    const isLoading = ref(true);
    const vueFlowReady = ref(!!window.VueFlow);
    const nodes = ref([]);
    const edges = ref([]);

    // Função para transformar a árvore em nós e arestas para o Vue Flow
    function buildFlowData(tree, x = 0, y = 0, parentId = null, depth = 0, siblingIndex = 0, siblingsCount = 1) {
      if (!tree) return { nodes: [], edges: [] };
      const nodeId = tree.id.toString();
      // Calcula posição: centraliza o root, espalha filhos horizontalmente
      const nodeX = x + (siblingIndex - (siblingsCount - 1) / 2) * 350;
      const nodeY = y + (depth === 0 ? 0 : 220);

      const node = {
        id: nodeId,
        position: { x: nodeX, y: nodeY },
        data: {
          ...tree,
          onIterate: () => emit('iterate-post', tree),
        },
        type: 'customNode',
        selectable: false,
      };
      let nodesArr = [node];
      let edgesArr = [];
      if (parentId) {
        edgesArr.push({
          id: `${parentId}-${nodeId}`,
          source: parentId,
          target: nodeId,
          animated: false,
          style: { stroke: '#a855f7', strokeWidth: 2 },
        });
      }
      if (tree.children && tree.children.length > 0) {
        tree.children.forEach((child, idx) => {
          const { nodes: childNodes, edges: childEdges } = buildFlowData(
            child,
            nodeX,
            nodeY + 220,
            nodeId,
            depth + 1,
            idx,
            tree.children.length
          );
          nodesArr = nodesArr.concat(childNodes);
          edgesArr = edgesArr.concat(childEdges);
        });
      }
      return { nodes: nodesArr, edges: edgesArr };
    }

    // Busca a árvore do Supabase
    const fetchTree = async () => {
      isLoading.value = true;
      try {
        const { data, error } = await window.app.supabase.rpc('get_post_tree', { root_id: props.rootPostId });
        if (error) throw error;
        treeData.value = data;
        // Monta os dados para o Vue Flow
        const { nodes: n, edges: e } = buildFlowData(data);
        nodes.value = n;
        edges.value = e;
      } catch (error) {
        emit('show-notification', 'Erro ao carregar árvore', 'error');
      } finally {
        isLoading.value = false;
      }
    };

    onMounted(() => {
      if (!window.VueFlow) {
        const check = setInterval(() => {
          if (window.VueFlow) {
            vueFlowReady.value = true;
            clearInterval(check);
            fetchTree();
          }
        }, 100);
      } else {
        fetchTree();
      }
    });

    // Custom node para mostrar thumbnail, email e botão de iterar
    const CustomNode = {
      props: ['data'],
      setup(props) {
        return { props };
      },
      template: `
        <div class="bg-[#18181b] border-2 border-[#a855f7] rounded-xl shadow-lg flex flex-col items-center p-3 min-w-[160px] max-w-[220px]">
          <img v-if="props.data.canvas_thumbnail_url" :src="props.data.canvas_thumbnail_url" class="w-20 h-20 rounded-lg object-cover mb-2"/>
          <div v-else class="w-20 h-20 rounded-lg bg-neutral-800 mb-2"></div>
          <div class="font-bold text-white text-center text-xs mb-1 break-all">{{ props.data.user_email }}</div>
          <button @click="props.data.onIterate()" class="mt-1 px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-1 text-xs">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-2.036A9 9 0 1112 3v1m0 0v4m0-4h4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Iterar
          </button>
        </div>
      `
    };

    return { treeData, isLoading, vueFlowReady, nodes, edges, CustomNode, emit };
  },
  template: `
    <div class="h-screen w-screen flex flex-col bg-black text-white">
      <header class="flex-shrink-0 flex items-center justify-between p-4 border-b border-neutral-800 bg-[#111111]/80 backdrop-blur-sm sticky top-0 z-10">
        <button @click="emit('back')" class="p-2 rounded-lg hover:bg-neutral-800 transition">&lt; Voltar ao Feed</button>
        <h2 class="text-lg font-semibold">Árvore de Evolução</h2>
        <div class="w-32"></div>
      </header>
      <main class="flex-1 overflow-hidden">
        <div v-if="!vueFlowReady" class="text-center py-10 text-blue-300">Carregando visualização interativa...</div>
        <div v-else-if="isLoading" class="text-center py-10">
          <div class="w-8 h-8 border-2 border-t-transparent border-[var(--accent-color)] rounded-full animate-spin mx-auto"></div>
          <p class="mt-2 text-neutral-400">Carregando árvore...</p>
        </div>
        <div v-else class="h-full w-full">
          <VueFlow
            :nodes="nodes"
            :edges="edges"
            fit-view
            :min-zoom="0.2"
            :max-zoom="2.5"
            :zoom-on-scroll="true"
            :pan-on-drag="true"
            :zoom-on-double-click="true"
            :pan-on-scroll="true"
            :nodes-draggable="false"
            :nodes-connectable="false"
            :elements-selectable="false"
            style="width:100vw;height:calc(100vh-64px);background:#18181b;"
          >
            <template #node-customNode="nodeProps">
              <component :is="CustomNode" v-bind="nodeProps" />
            </template>
            <VueFlowControls />
            <VueFlowMinimap />
          </VueFlow>
        </div>
      </main>
    </div>
  `
});

app.component('FeedComponent', {
  props: ['user'],
  emits: ['create-post', 'iterate-post', 'view-tree', 'show-notification', 'logout'],
  setup(props, { emit }) {
    const posts = ref([]);
    const profiles = ref({});
    const likes = ref([]);
    const favorites = ref([]);
    const commentsCount = ref({});
    const loading = ref(true);
    const showPostModal = ref(false);
    const showCommentsModal = ref(false);
    const selectedPost = ref(null);
    const comments = ref([]);
    const newComment = ref('');
    const feedComments = ref({});
    const carouselIndex = ref({});
    const bodyOverflow = ref('');

    const showEmojiPicker = ref({});

const toggleEmojiPicker = (postId) => {
  showEmojiPicker.value[postId] = !showEmojiPicker.value[postId];
};

const onEmojiSelect = (event, postId) => {
  newComment.value += event.detail.unicode;
  showEmojiPicker.value[postId] = false;
};

    // Busca posts e dados relacionados
    const fetchPosts = async () => {
      loading.value = true;
      try {
        const { data: postsData } = await window.app.supabase
          .from('posts')
          .select('*')
          .is('parent_post_id', null)
          .order('created_at', { ascending: false });
        posts.value = postsData || [];
        // Perfis
        const userIds = [...new Set(posts.value.map(p => p.user_id))];
        if (userIds.length > 0) {
          const { data: profilesData } = await window.app.supabase.from('profiles').select('*').in('id', userIds);
          profiles.value = Object.fromEntries((profilesData||[]).map(p => [p.id, p]));
        }
        // Likes do usuário logado
        const { data: likesData } = await window.app.supabase.from('likes').select('post_id').eq('user_id', props.user.id);
        likes.value = likesData ? likesData.map(l => l.post_id) : [];
        // Favoritos do usuário logado
        const { data: favData } = await window.app.supabase.from('favorites').select('post_id').eq('user_id', props.user.id);
        favorites.value = favData ? favData.map(f => f.post_id) : [];
        // Contagem de likes por post
        const { data: allLikes } = await window.app.supabase.from('likes').select('post_id');
        const likeCountMap = {};
        (allLikes || []).forEach(l => {
          likeCountMap[l.post_id] = (likeCountMap[l.post_id] || 0) + 1;
        });
        // Contagem de comentários
        const { data: commentsData } = await window.app.supabase.from('comments').select('post_id, id, comment_text, user_id, created_at');
        const countMap = {};
        const previewMap = {};
        (commentsData || []).forEach(c => {
          countMap[c.post_id] = (countMap[c.post_id] || 0) + 1;
          if (!previewMap[c.post_id]) previewMap[c.post_id] = [];
          if (previewMap[c.post_id].length < 2) previewMap[c.post_id].push(c);
        });
        commentsCount.value = countMap;
        feedComments.value = previewMap;
        // Atualiza os contadores nos posts
        posts.value.forEach(post => {
          post.like_count = likeCountMap[post.id] || 0;
        });
        posts.value = [...posts.value];
      } catch (error) {
        emit('show-notification', 'Erro ao carregar feed.', 'error');
      } finally {
        loading.value = false;
      }
    };
    onMounted(fetchPosts);

    // Like/Favorite
    // ...dentro do setup do FeedComponent...
    onMounted(fetchPosts);

    const onEmojiClick = (post) => {
  newComment.value += "😊";
};

// Permite atualizar o feed manualmente pelo navBar
window.refreshFeed = fetchPosts;

const toggleLike = async (postId) => {
  if (likes.value.includes(postId)) {
    await window.app.supabase.from('likes').delete().eq('user_id', props.user.id).eq('post_id', postId);
    likes.value = likes.value.filter(id => id !== postId);
    // Atualize o contador localmente
    const post = posts.value.find(p => p.id === postId);
    if (post) post.like_count = Math.max(0, (post.like_count || 1) - 1);
  } else {
    await window.app.supabase.from('likes').insert({ user_id: props.user.id, post_id: postId });
    likes.value.push(postId);
    const post = posts.value.find(p => p.id === postId);
    if (post) post.like_count = (post.like_count || 0) + 1;
  }
  // Não chame fetchPosts() aqui!
};

const toggleFavorite = async (postId) => {
  const navFavBtn = document.getElementById('nav-favorites');
  const navFav = navFavBtn ? navFavBtn.querySelector('svg') : null;
  if (!favorites.value.includes(postId)) {
    await window.app.supabase.from('favorites').insert({ user_id: props.user.id, post_id: postId });
    favorites.value.push(postId);

    // Efeito de brilho e cor amarela (fade elegante)
    if (navFavBtn) {
      navFavBtn.classList.add('fav-glow');
      setTimeout(() => navFavBtn.classList.remove('fav-glow'), 1200);
    }
    if (navFav) {
      navFav.classList.remove('spin-fav');
      void navFav.offsetWidth;
      navFav.classList.add('spin-fav');
    }

    // Partículas - chuveiro de estrelinhas subindo
    if (navFavBtn) {
      let oldParticles = navFavBtn.querySelector('.fav-particles');
      if (oldParticles) oldParticles.remove();

      const particles = document.createElement('div');
      particles.className = 'fav-particles';
      navFavBtn.style.position = 'relative';

      for (let i = 0; i < 18; i++) {
        const star = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        star.setAttribute('viewBox', '0 0 24 24');
        star.setAttribute('width', '14');
        star.setAttribute('height', '14');
        star.classList.add('fav-particle');
        star.innerHTML = `<polygon points="12,2 15,9 22,9.5 17,14.5 18.5,22 12,18 5.5,22 7,14.5 2,9.5 9,9" fill="#fde047"/>`;

        // Coluna (espalhamento horizontal)
        const x = (Math.random() - 0.5) * 32; // -16px a +16px
        // Altura inicial e final (para dar efeito de "chuveiro" subindo)
        const y1 = -30 - Math.random() * 10;
        const y2 = y1 - 40 - Math.random() * 20;
        // Tamanho e delay aleatórios
        const scale = 0.7 + Math.random() * 0.7;
        const delay = Math.random() * 0.4;
        const duration = 0.8 + Math.random() * 0.5;

        star.style.setProperty('--x', `${x}px`);
        star.style.setProperty('--y1', `${y1}px`);
        star.style.setProperty('--y2', `${y2}px`);
        star.style.setProperty('--scale', scale);
        star.style.animationDelay = `${delay}s`;
        star.style.animationDuration = `${duration}s`;

        particles.appendChild(star);
      }
      navFavBtn.appendChild(particles);

      setTimeout(() => {
        particles.remove();
      }, 1700);
    }

    // Remove a classe spin-fav após animação para permitir múltiplos spins
    if (navFav) {
      navFav.addEventListener('animationend', function handler() {
        navFav.classList.remove('spin-fav');
        navFav.removeEventListener('animationend', handler);
      });
    }
  } else {
    await window.app.supabase.from('favorites').delete().eq('user_id', props.user.id).eq('post_id', postId);
    favorites.value = favorites.value.filter(id => id !== postId);
  }
  // Não chame fetchPosts() aqui!
};

    // Modal de post
    const openPostModal = (post) => {
      selectedPost.value = post;
      showPostModal.value = true;
      carouselIndex.value[post.id] = 0;
      bodyOverflow.value = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
    };
    const closePostModal = () => {
      showPostModal.value = false;
      selectedPost.value = null;
      showCommentsModal.value = false;
      document.body.style.overflow = bodyOverflow.value;
    };

    // Modal de comentários
      const openCommentsModal = async (post) => {
        selectedPost.value = post;
        showCommentsModal.value = true;
        await fetchComments(post.id);
      };
    const closeCommentsModal = () => {
      showCommentsModal.value = false;
      comments.value = [];
      showEmojiPicker.value = {};
    };

    // Comentários
    const fetchComments = async (postId) => {
      const { data } = await window.app.supabase.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: true });
      comments.value = data || [];
    };
   const sendComment = async (post) => {
  if (!newComment.value.trim()) return;
  const { data, error } = await window.app.supabase.from('comments').insert({
    post_id: post.id,
    user_id: props.user.id,
    comment_text: newComment.value
  }).select().single();
  if (!error && data) {
    newComment.value = '';
    await fetchComments(post.id);
    commentsCount.value[post.id] = (commentsCount.value[post.id] || 0) + 1;
  }
};

    // Helpers
    const timeAgo = (date) => {
      if (!date) return '';
      const now = new Date();
      const diff = (now - new Date(date)) / 1000;
      if (diff < 60) return 'agora mesmo';
      if (diff < 3600) return `há ${Math.floor(diff/60)} min`;
      if (diff < 86400) return `há ${Math.floor(diff/3600)} h`;
      return `há ${Math.floor(diff/86400)} d`;
    };

    return {
      posts, profiles, likes, favorites, commentsCount, loading,
      toggleLike, toggleFavorite,
      showPostModal, openPostModal, closePostModal,
      showCommentsModal, openCommentsModal, closeCommentsModal,
      selectedPost, comments, newComment, sendComment,
      feedComments, carouselIndex, timeAgo, emit, onEmojiClick, showEmojiPicker,
      onEmojiSelect, toggleEmojiPicker
    };
  },
  template: `
    <div class="h-full w-full flex flex-col bg-[#111]">
      <header class="flex items-center justify-between p-4 border-b border-neutral-800 bg-[#111111]/80 backdrop-blur-sm sticky top-0 z-10">
        <img src="https://res.cloudinary.com/dsqpboeky/image/upload/c_crop,w_750,h_340/v1750529901/Gemini_Generated_Image_krs9u5krs9u5krs9_1_4_melpei.png" alt="Logo Iterate" class="w-32 h-18 fade-in"> 
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-400 hidden sm:block">{{ profiles[user.id]?.full_name || user.email }}</span>
          <button @click="emit('logout')" class="p-2 rounded-full hover:bg-neutral-800 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          </button>
        </div>
      </header>
      <main class="flex-1 overflow-y-auto p-7">
        <div v-if="loading" class="relative inset-0 flex items-center justify-center min-h-[80vh]">
          <img src="https://res.cloudinary.com/dsqpboeky/image/upload/v1750530386/Gemini_Generated_Image_krs9u5krs9u5krs9_1_3_dqteho.png" alt="Loading" class="w-32 h-45 pulse-logo" draggable="false"/>
        </div>
        <div v-else-if="posts.length === 0" class="text-center py-20 px-4">
          <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"></path></svg>
          <h2 class="mt-4 text-2xl font-semibold text-white">O feed está vazio</h2>
          <p class="mt-2 text-neutral-400">Seja o primeiro a inspirar a comunidade! Crie um post.</p>
        </div>
        <div v-else class="max-w-md mx-auto flex flex-col gap-8 pb-24">
          <div v-for="post in posts" :key="post.id" class="rounded-xl p-[1.5px] bg-gradient-to-r from-[#2563eb] via-[#a855f7] to-[#ec4899] shadow-sm transition-all duration-300 relative">
            <div class="bg-neutral-900 rounded-xl overflow-hidden">
            <!-- Topo -->
            <div class="flex items-center justify-between px-4 pt-3 pb-2">
              <div class="flex items-center gap-3">
            <img :src="profiles[post.user_id]?.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profiles[post.user_id]?.full_name || post.user_email)" class="w-9 h-9 rounded-full object-cover border border-neutral-300">
            <span class="font-bold text-white text-sm">{{ profiles[post.user_id]?.full_name || post.user_email }}</span>
           </div>
           <button class="p-1 text-white/70 hover:bg-neutral-100 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/></svg>
              </button>
            </div>
            <!-- Imagem/Carrossel -->
            <div class="relative w-full bg-black cursor-pointer">
              <img v-if="post.canvas_thumbnail_url" :src="post.canvas_thumbnail_url" class="w-full aspect-square object-cover"/>
              <div v-else class="w-full aspect-square flex items-center justify-center text-neutral-500 text-sm bg-neutral-900">Sem prévia</div>
              <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1">
                <span class="w-2 h-2 rounded-full bg-white/30"></span>
              </div>
            </div>
             <!-- Ações -->
              <div class="flex items-center justify-between px-4 pt-3 pb-1">
              <div class="flex items-center gap-4">
                <button  type="button" @click="toggleLike(post.id)" :class="likes.includes(post.id) ? 'text-pink-500 scale-110' : 'text-white/80'" class="transition-all duration-200 hover:scale-125">
                  <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"></path></svg>
                </button>
                <button type="button" @click.stop="openCommentsModal(post)" class="text-white/80 transition-all duration-200 hover:scale-125">
                  <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4-.8l-4.28 1.07a1 1 0 01-1.22-1.22l1.07-4.28A8.96 8.96 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                </button>
                <button type="button" @click="toggleFavorite(post.id)" :class="favorites.includes(post.id) ? 'text-yellow-400 scale-110' : 'text-white/80'" class="transition-all duration-200 hover:scale-125">
                  <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.562-.955L10 0l2.95 5.955 6.562.955-4.756 4.635 1.122 6.545z"/></svg>
                </button>
              </div>
              <button @click="emit('iterate-post', post)" class="p-2 rounded-full text-white hover:bg-blue-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16.862 4.487l-9.9 9.9a2.25 2.25 0 003.182 3.182l9.9-9.9a2.25 2.25 0 10-3.182-3.182z"></path></svg>
              </button>
             </div>
                <!-- Curtidas -->
                <div class="px-4 pb-1">
                  <span class="font-bold text-white text-sm">{{ post.like_count || 0 }} curtidas</span>
                </div>
                <!-- Iterações -->
<div class="px-4 pb-1 flex items-center gap-2">
  <button
    @click="emit('view-tree', post)"
    class="flex items-center gap-1 text-purple-400 hover:text-purple-300 text-sm font-semibold transition"
    title="Ver árvore de iterações"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
    </svg>
    Iterações
    <span v-if="post.iteration_count !== undefined" class="ml-1 px-2 py-0.5 rounded-full bg-purple-700 text-white text-xs">{{ post.iteration_count }}</span>
  </button>
</div>
                <!-- Legenda -->
                <div class="px-4 pb-1">
                  <span class="font-bold text-white text-sm">{{ profiles[post.user_id]?.full_name || post.user_email }}</span>
                  <span class="text-black/90 text-sm ml-1">{{ post.caption ? post.caption.slice(0, 60) : '' }}<span v-if="post.caption && post.caption.length > 60" class="text-blue-400 cursor-pointer"> ver mais</span></span>
                </div>
                <!-- Comentários (máx 2) -->
                <div v-if="commentsCount[post.id] > 0" class="px-4 pb-1">
                  <button @click="openPostModal(post)" class="text-neutral-500 text-sm hover:underline">Ver todos os {{ commentsCount[post.id] }} comentários</button>
                  <div v-for="c in feedComments[post.id]" :key="c.id" class="text-white/80 text-sm"><span class="font-bold">{{ profiles[c.user_id]?.full_name || c.user_id }}</span> {{ c.comment_text }}</div>
                </div>
                <!-- Timestamp -->
                <div class="px-4 pb-2">
                  <span class="text-xs text-neutral-400">{{ timeAgo(post.created_at) }}</span>
                </div>
                <!-- Campo de comentário -->
                <div class="flex items-center gap-2 px-4 pb-3">
                <img :src="profiles[user.id]?.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profiles[user.id]?.full_name || user.email)" class="w-8 h-8 rounded-full object-cover">
                <input
                  v-model="newComment"
                  class="flex-1 px-3 py-2 rounded-full bg-neutral-100 border border-neutral-200 text-black text-sm"
                  placeholder="Adicione um comentário..."
                  @keydown.enter="sendComment(post)"
                >
                <div style="position:relative;">
  <button type="button" class="text-xl text-neutral-400" @click="toggleEmojiPicker(post.id)">😊</button>
<div v-if="showEmojiPicker[post.id]" class="absolute bottom-10 left-0" style="z-index:9999;">
  <emoji-picker @emoji-click="e => onEmojiSelect(e, post.id)"></emoji-picker>
</div>
</div>
                <button type="button" class="ml-1 text-blue-500" @click="sendComment(post)">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2 21l21-9-21-9v7l15 2-15 2z"/></svg>
                </button>
              </div>

              </div>
            </div>
            <transition name="slide-up">
  <div
    v-if="showCommentsModal && selectedPost && selectedPost.id === post.id"
    class="absolute left-0 right-0 z-[200] flex justify-center"
    style="top: 100%;"
    @click.self="closeCommentsModal"
  >
    <div class="w-full max-w-md mx-auto relative flex flex-col animate-slide-up"
      style="
        background: rgba(17,17,17,0.90);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 16px 16px 16px 16px;
        box-shadow: 0 8px 32px 0 rgba(0,0,0,0.37);
        max-height: 420px;
        min-height: 220px;
        margin-bottom: 80px; /* altura da navBar */
      "
      @click.stop
    >
      <!-- Campo de comentário no topo -->
     <div class="flex items-center gap-2 px-4 pb-3" style="position:relative;">
  <img :src="profiles[user.id]?.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profiles[user.id]?.full_name || user.email)" class="w-8 h-8 rounded-full object-cover">
  <input
    v-model="newComment"
    class="flex-1 px-3 py-2 rounded-full bg-neutral-100 border border-neutral-200 text-black text-sm"
    placeholder="Adicione um comentário..."
    @keydown.enter="sendComment(post)"
  >
  <div style="position:relative;">
  <button type="button" class="text-xl text-neutral-400" @click="toggleEmojiPicker(post.id)">😊</button>
<div v-if="showEmojiPicker[post.id]" class="absolute bottom-10 left-0" style="z-index:9999;">
  <emoji-picker @emoji-click="e => onEmojiSelect(e, post.id)"></emoji-picker>
</div>
</div>
  <button type="button" class="ml-1 text-blue-500" @click="sendComment(post)">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2 21l21-9-21-9v7l15 2-15 2z"/></svg>
  </button>
</div>
        <!-- Ícone de comentários -->
        <button type="button" @click.stop="openCommentsModal(post)" class="text-white/80 transition-all duration-200 hover:scale-125">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4-.8l-4.28 1.07a1 1 0 01-1.22-1.22l1.07-4.28A8.96 8.96 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        </button>

          <!-- "Ver todos os X comentários" -->
          <button @click="openCommentsModal(post)" class="text-neutral-500 text-sm hover:underline">
            Ver todos os {{ commentsCount[post.id] }} comentários
          </button>
        <!-- Lista de comentários -->
        <div class="flex-1 overflow-y-auto px-2 py-2 scrollbar-thin scrollbar-thumb-neutral-700 scrollbar-track-transparent" style="max-height: 320px;">
        <div v-if="comments.length === 0" class="text-center text-neutral-400 py-8">Nenhum comentário ainda.</div>
        <div v-else>
          <div v-for="c in comments" :key="c.id" class="flex items-start gap-2 py-3 border-b border-neutral-800 last:border-b-0">
            <img :src="profiles[c.user_id]?.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profiles[c.user_id]?.full_name || c.user_id)" class="w-8 h-8 rounded-full object-cover bg-gray-700">
            <div class="flex-1">
              <p class="font-semibold text-white text-sm">{{ profiles[c.user_id]?.full_name || c.user_id }}</p>
              <p class="text-neutral-400 text-xs">{{ new Date(c.created_at).toLocaleString('pt-BR') }}</p>
              <p class="text-white mt-1 break-words">{{ c.comment_text }}</p>
            </div>
          </div>
        </div>
          </div>
          </div>
        </div>
        </transition>
         </div>
        </main>

          <!-- MODAL DE POST -->
          <!-- Removido o modal de post -->

          <!-- MODAL DE COMENTÁRIOS -->
      
          </div>
        `
        });

        app.component('EditorComponent', {
            props: ['postToEdit'],
            emits: ['back', 'show-notification'],
            setup(props, { emit }) {
                const canvasRef = ref(null);
                let fabricCanvas = null;
                const loading = ref(false);

                onMounted(() => {
                    if (!canvasRef.value) return;
                    fabricCanvas = new fabric.Canvas(canvasRef.value, { backgroundColor: '#18181b', preserveObjectStacking: true });
                    const resizeCanvas = () => {
                        if (!canvasRef.value || !canvasRef.value.parentElement) return;
                        const container = canvasRef.value.parentElement;
                        fabricCanvas.setWidth(container.clientWidth); fabricCanvas.setHeight(container.clientHeight);
                        fabricCanvas.renderAll();
                    };
                    const resizeObserver = new ResizeObserver(resizeCanvas);
                    resizeObserver.observe(canvasRef.value.parentElement);
                    resizeCanvas();
                    if (props.postToEdit && props.postToEdit.canvas_json) {
                        fabricCanvas.loadFromJSON(props.postToEdit.canvas_json, fabricCanvas.renderAll.bind(fabricCanvas));
                    }
                });

                const addRect = () => fabricCanvas.add(new fabric.Rect({ left: 50, top: 50, fill: '#3B82F6', width: 150, height: 100 }));
                const addCircle = () => fabricCanvas.add(new fabric.Circle({ left: 100, top: 100, radius: 50, fill: '#EC4899' }));
                const addText = () => fabricCanvas.add(new fabric.IText('Edite!', { left: 120, top: 120, fill: '#FFFFFF', fontFamily: 'Inter' }));
                const deleteSelected = () => {
                    fabricCanvas.getActiveObjects().forEach(obj => fabricCanvas.remove(obj));
                    fabricCanvas.discardActiveObject().renderAll();
                };

                const saveCanvas = async () => {
                    loading.value = true;
                    try {
                        const user = window.app.session.user;
                        const canvasJSON = JSON.stringify(fabricCanvas.toJSON());
                        const canvasThumbnail = fabricCanvas.toDataURL({ format: 'png', multiplier: 500 / fabricCanvas.getWidth() });
                        
                        const postData = { user_id: user.id, user_email: user.email, canvas_json: canvasJSON, canvas_thumbnail_url: canvasThumbnail };

                        if (props.postToEdit) {
                            postData.parent_post_id = props.postToEdit.id;
                            await window.app.supabase.from('posts').insert(postData);
                            await window.app.supabase.rpc('increment_iteration_count', { post_id_to_update: props.postToEdit.id });
                        } else {
                            await window.app.supabase.from('posts').insert(postData);
                        }
                        emit('show-notification', 'Post salvo com sucesso!', 'success');
                        emit('back');
                    } catch (error) {
                        emit('show-notification', 'Erro ao salvar: ' + error.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                return { canvasRef, loading, addRect, addCircle, addText, deleteSelected, saveCanvas, emit };
            },
            template: `
                <div class="h-screen w-screen flex flex-col bg-black text-white">
                    <div v-if="loading" class="absolute inset-0 bg-black/70 flex items-center justify-center z-20"><div class="w-16 h-16 border-4 border-t-transparent border-[var(--accent-color)] rounded-full animate-spin"></div></div>
                    <header class="flex-shrink-0 flex items-center justify-between p-4 border-b border-neutral-800 bg-[#111111]">
                        <button @click="emit('back')" class="p-2 rounded-lg hover:bg-neutral-800 transition"> &lt; Voltar </button>
                        <h2 class="text-lg font-semibold">{{ postToEdit ? 'Iterando Post' : 'Novo Post Semente' }}</h2>
                        <button @click="saveCanvas" class="btn-primary px-4 py-2"> Salvar </button>
                    </header>
                    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                        <aside class="flex-shrink-0 md:w-24 bg-[#111111] border-r border-neutral-800 flex md:flex-col items-center p-2 gap-2">
                            <button @click="addRect" class="p-2 rounded-lg hover:bg-neutral-700 transition">Retângulo</button>
                            <button @click="addCircle" class="p-2 rounded-lg hover:bg-neutral-700 transition">Círculo</button>
                            <button @click="addText" class="p-2 rounded-lg hover:bg-neutral-700 transition">Texto</button>
                            <div class="my-auto"></div>
                            <button @click="deleteSelected" class="p-2 rounded-lg text-[var(--danger-color)] hover:bg-red-900/50 transition">Deletar</button>
                        </aside>
                        <main class="flex-1 bg-neutral-900 relative overflow-hidden"><canvas ref="canvasRef"></canvas></main>
                    </div>
                </div>
            `,
        });
        
        // ProfileComponent
app.component('profile-component', {
  props: ['user'],
  setup(props) {
    const profile = ref(null);
    const posts = ref([]);
    const loading = ref(true);
    const editing = ref(false);
    const form = reactive({ full_name: '', avatar_url: '', bio: '' });

    const fetchProfile = async () => {
      loading.value = true;
      const { data: profileData } = await window.app.supabase.from('profiles').select('*').eq('id', props.user.id).single();
      profile.value = profileData;
      if (profileData) {
        form.full_name = profileData.full_name || '';
        form.avatar_url = profileData.avatar_url || '';
        form.bio = profileData.bio || '';
      }
      const { data: postData } = await window.app.supabase.from('posts').select('*').eq('user_id', props.user.id);
      posts.value = postData;
      loading.value = false;
    };

    const saveProfile = async () => {
      loading.value = true;
      if (profile.value) {
        await window.app.supabase.from('profiles').update({
          full_name: form.full_name,
          avatar_url: form.avatar_url,
          bio: form.bio
        }).eq('id', props.user.id);
      } else {
        await window.app.supabase.from('profiles').insert({
          id: props.user.id,
          full_name: form.full_name,
          avatar_url: form.avatar_url,
          bio: form.bio
        });
      }
      editing.value = false;
      await fetchProfile();
    };

    onMounted(fetchProfile);
    return { profile, posts, loading, editing, form, saveProfile, fetchProfile };
  },
  template: `
    <div v-if="loading" class="flex items-center justify-center h-full"><div class="w-10 h-10 border-2 border-t-transparent rounded-full animate-spin"></div></div>
    <div v-else>
      <div class="p-4 md:p-6 max-w-2xl mx-auto">
        <div v-if="editing || !profile">
          <h2 class="text-xl font-bold mb-4">{{ profile ? 'Editar Perfil' : 'Criar Perfil' }}</h2>
          <form @submit.prevent="saveProfile" class="space-y-4">
            <div>
              <label class="block text-sm mb-1">Nome</label>
              <input v-model="form.full_name" class="w-full px-3 py-2 rounded bg-neutral-800 border border-neutral-700 text-white" required>
            </div>
            <div>
              <label class="block text-sm mb-1">Avatar (URL)</label>
              <input v-model="form.avatar_url" class="w-full px-3 py-2 rounded bg-neutral-800 border border-neutral-700 text-white">
            </div>
            <div>
              <label class="block text-sm mb-1">Bio</label>
              <textarea v-model="form.bio" class="w-full px-3 py-2 rounded bg-neutral-800 border border-neutral-700 text-white"></textarea>
            </div>
            <button type="submit" class="btn-primary px-6 py-2">Salvar</button>
            <button v-if="profile" type="button" @click="editing=false" class="ml-2 px-6 py-2 rounded bg-neutral-700 text-white">Cancelar</button>
          </form>
        </div>
        <div v-else>
          <div class="flex items-center gap-4 mb-6">
            <img :src="profile.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profile.full_name || user.email)" class="w-20 h-20 md:w-24 md:h-24 rounded-full object-cover bg-gray-700">
            <div class="flex-1">
              <h1 class="text-2xl font-bold">{{ profile.full_name }}</h1>
              <p class="text-gray-400 text-sm">{{ profile.bio || 'Sem bio.' }}</p>
            </div>
            <button @click="editing=true" class="btn-primary px-4 py-2">Editar Perfil</button>
          </div>
          <h2 class="font-bold mb-4 text-lg">Criações</h2>
          <div v-if="posts.length > 0" class="grid grid-cols-3 gap-1">
            <div v-for="post in posts" :key="post.id" class="aspect-square bg-neutral-800">
              <img :src="post.canvas_thumbnail_url" class="w-full h-full object-cover"/>
            </div>
          </div>
          <p v-else class="text-gray-500">Este usuário ainda não criou nada.</p>
        </div>
      </div>
    </div>
  `
});

// FavoritesComponent
app.component('favorites-component', {
  props: ['user'],
  emits: ['show-notification'],
  setup(props, { emit }) {
    const favoritePosts = ref([]);
    const loading = ref(true);
    const fetchFavorites = async () => {
      loading.value = true;
      try {
        const { data: favorites } = await window.app.supabase.from('favorites').select('post_id').eq('user_id', props.user.id);
        const postIds = favorites.map(f => f.post_id);
        if (postIds.length === 0) { favoritePosts.value = []; loading.value = false; return; }
        const { data: postData } = await window.app.supabase.from('posts').select('*').in('id', postIds);
        favoritePosts.value = postData;
      } catch (e) { emit('show-notification', 'Erro ao carregar favoritos.', 'error'); }
      loading.value = false;
    };
    onMounted(fetchFavorites);
    return { favoritePosts, loading };
  },
  template: `
    <div class="p-2 md:p-4">
      <h1 class="text-2xl font-bold p-2 text-white">Favoritos</h1>
      <div v-if="loading" class="text-center py-10 text-gray-400">Carregando favoritos...</div>
      <div v-else-if="favoritePosts.length === 0" class="text-center py-20 px-4">
        <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.757l1.318-1.44a4.5 4.5 0 116.364 6.364L12 20.06l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
        <h2 class="mt-4 text-2xl font-semibold text-white">Nenhum favorito ainda</h2>
        <p class="mt-2 text-neutral-400">Explore o feed e salve suas inspirações!</p>
      </div>
      <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-4">
        <div v-for="post in favoritePosts" :key="post.id" class="aspect-square bg-neutral-800 rounded-2xl overflow-hidden">
          <img :src="post.canvas_thumbnail_url" class="w-full h-full object-cover"/>
        </div>
      </div>
    </div>
  ` 
});

        app.config.compilerOptions.isCustomElement = tag => tag === 'emoji-picker';

        // Montagem final do App
        app.mount('#app');
        window.app = app._instance.setupState;

        // ========== BARRA DE NAVEGAÇÃO INFERIOR ==========
        // Adiciona a barra de navegação fixa com ícones e labels
        const navBar = document.createElement('nav');
        navBar.className = 'fixed bottom-0 left-0 w-full h-20 bg-[#181818]/60 backdrop-blur border-t border-neutral-800 flex items-center justify-around z-50';
        navBar.innerHTML = `
          <button id="nav-feed" class="flex flex-col items-center justify-center text-xs w-16 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            <span class="nav-label">Feed</span>
          </button>
          <button id="nav-favorites" class="flex flex-col items-center justify-center text-xs w-16 text-gray-400">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.562-.955L10 0l2.95 5.955 6.562.955-4.756 4.635 1.122 6.545z"/></svg>
            <span class="nav-label">Favoritos</span>
          </button>
          <button id="nav-create" class="flex items-center justify-center w-14 h-14 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl text-white shadow-lg -mt-8">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          </button>
          <button id="nav-notifications" class="flex flex-col items-center justify-center text-xs w-16 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
            <span class="nav-label">Notificações</span>
          </button>
          <button id="nav-profile" class="flex flex-col items-center justify-center text-xs w-16 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path></svg>
            <span class="nav-label">Perfil</span>
          </button>
        `;
        document.body.appendChild(navBar);

        document.querySelectorAll('nav button').forEach(btn => {
         btn.addEventListener('mouseenter', () => {
              if (!btn.classList.contains('nav-selected') && !btn.classList.contains('nav-selected-yellow')) {
                btn.classList.add('nav-hover');
              }
            });
            btn.addEventListener('mouseleave', () => {
              btn.classList.remove('nav-hover');
            });
          });

        // ========== GARANTIR VUE FLOW SÓ NO COMPONENTE TREE ==========
        // Exemplo de uso seguro dentro do componente TreeViewComponent:
        // const { VueFlow, useVueFlow } = window.VueFlow || {};
        // if (!VueFlow) { /* mostrar erro amigável ou loading */ }

        // Adiciona navegação da barra inferior
function setNavActive(id) {
  document.querySelectorAll('nav button').forEach(btn => {
    btn.classList.remove('nav-selected', 'nav-selected-yellow');
    btn.querySelector('svg').style.filter = '';
  });
  const btn = document.getElementById(id);
  if (!btn) return;
  if (id === 'nav-favorites') {
    btn.classList.add('nav-selected-yellow');
    btn.querySelector('svg').style.filter = 'drop-shadow(0 0 8px #fde047) drop-shadow(0 0 16px #fde047)';
  } else if (['nav-feed', 'nav-notifications', 'nav-profile'].includes(id)) {
    btn.classList.add('nav-selected');
    btn.querySelector('svg').style.filter = 'drop-shadow(0 0 8px #2563eb) drop-shadow(0 0 16px #a855f7)';
  }
}

document.getElementById('nav-feed').onclick = () => {
  window.app.currentView = 'feed';
  setNavActive('nav-feed');
  if (typeof window.refreshFeed === 'function') window.refreshFeed();
};
document.getElementById('nav-favorites').onclick = () => { window.app.currentView = 'favorites'; setNavActive('nav-favorites'); };
document.getElementById('nav-create').onclick = () => { window.app.currentView = 'editor'; setNavActive('nav-create'); };
document.getElementById('nav-notifications').onclick = () => { window.app.currentView = 'notifications'; setNavActive('nav-notifications'); };
document.getElementById('nav-profile').onclick = () => { window.app.currentView = 'profile'; setNavActive('nav-profile'); };
setNavActive('nav-feed');




    </script>
</body>
</html>
